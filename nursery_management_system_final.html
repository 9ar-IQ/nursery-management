<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Nursery Management System</title>
    <script type="text/javascript" src="https://me.kis.v2.scr.kaspersky-labs.com/FD126C42-EBFA-4E12-B309-BB3FDD723AC1/main.js?attr=Dw3txtSyBC7mhHjEa_zOuhcym08G88Bgpjjgm-Z46PLRwddhLR5L6h1v_CPgChTiFCN_7Z3t9dAGv_o6rUcm8VwGtCd939N9M1xkSNMGzdx2qbHKYdRpeG_ieK-1wJKcgJltUPvHqA8B6e8L3LUEFqMOK2kIaxPRkFIhgw2OfW1V6oO7qws3qaY1MhXAFpxLd47vbBVkx67_OFwUdLAaLauL2EhwR7aT0YUuLImPAWHO39z2wmab4YWBrikX1RbLDI0Z7SRQlFdCZ6hO4jb3rqYuMYQTm6pWu3Tcj0N1eilQAYJzRa0K_G4w59PWQVVTQN_zqqf6XKCeLtKl9cKgYNzAf_4BtZ4f2mNLgHAt59NWY56Fg9HNwOkzIGD_HGqZ5Vuob-9wnEb9cUh3KoOCDlZY0U7k6E1B5ux9y_4ODTGsmRajhFERF3VBM7Ufi6q79PPT4-PyCOtaoxL4toTdFOmR6R7JZijFI82ZoqctTcBhbjFNqzi0YinzMgptmCAbyPnDuPdEuZVJAbc3uuBJR76tzZMG_Inkd3wQdw2U1wxdLCFimWq3H1qGU817hOGX3q1OQaIq4UA-VJgOaGSf5m09Z9M2SEelyqbGLo_7ZAGYNs_8fSFRjdsXwNOJVfPnVeiiqXulTlqYdg6Te-LkTnRAkk1-foX4YNw6dmgtdapBuKK5q_coqzjivQ8Oc19fCR-t_Xy2_hcmxpwvW3QIfxdF-rMFaOgsCTsXacPiBj9W8QgPlFcK2MZaNq0Jd8LjsQPAkwWmdtsD_UVBWVNgOzIB3iq1YGhnu_Tv1_08UKxH7hSdVVpF9bpttjELHXrJd0AADqwvqqzk7P9YtxJQ8X0IKD5FC7iywr2RUO1XpULZhSCgoqYA3ll12MkjGjDqefH_9-Kk8F2IUK6ON1zC_Eh-RRcJ4BcKCVFgEOqpFgYoNfAA7vga3iiFBmSTbDIE" charset="UTF-8"></script><link rel="stylesheet" crossorigin="anonymous" href="https://me.kis.v2.scr.kaspersky-labs.com/E3E8934C-235A-4B0E-825A-35A08381A191/abn/main.css?attr=aHR0cHM6Ly92aWRhLXByaXZhdGUuczMudXMtZWFzdC0xLmFtYXpvbmF3cy5jb20vc2Vzc2lvbkZpbGUvbWFEOU9aVmxTNnlWZm9ia1Jma3Boei9zYW5kYm94L010aDhOdnJ5Z1pySkdiRlAzQnZxWjRfMTc0ODA5NzYyNzY4Nl9uYTFmbl9MMmh2YldVdmRXSjFiblIxTDI1MWNuTmxjbmxmYldGdVlXZGxiV1Z1ZEY5emVYTjBaVzFmWm1sdVlXdy5odG1sP1gtQW16LUFsZ29yaXRobT1BV1M0LUhNQUMtU0hBMjU2JlgtQW16LUNvbnRlbnQtU2hhMjU2PVVOU0lHTkVELVBBWUxPQUQmWC1BbXotQ3JlZGVudGlhbD1BS0lBWlYzQTJFQ1pPRkhWVDRVViUyZjIwMjUwNTI0JTJmdXMtZWFzdC0xJTJmczMlMmZhd3M0X3JlcXVlc3QmWC1BbXotRGF0ZT0yMDI1MDUyNFQxNDQzNDFaJlgtQW16LUV4cGlyZXM9NjAzODAwJlgtQW16LVNpZ25hdHVyZT00ZTMwYzMwMDhiZDMxYmZjOTk4OTcyZDVlYTYxMThkNjY5NzIzOTk1ZDY4MGJiMDFiNzBmMjMwYzNkNTgwNjNhJlgtQW16LVNpZ25lZEhlYWRlcnM9aG9zdCZyZXNwb25zZS1jb250ZW50LWRpc3Bvc2l0aW9uPWF0dGFjaG1lbnQlM2IlMjBmaWxlbmFtZSUyYSUzZFVURi04JTI3JTI3bnVyc2VyeV9tYW5hZ2VtZW50X3N5c3RlbV9maW5hbC5odG1sJnJlc3BvbnNlLWNvbnRlbnQtdHlwZT10ZXh0JTJmaHRtbCZ4LWFtei1jaGVja3N1bS1tb2RlPUVOQUJMRUQmeC1pZD1HZXRPYmplY3Q"/><style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            color: #333;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
        }

        .login-container {
            background: white;
            padding: 40px;
            border-radius: 15px;
            box-shadow: 0 15px 35px rgba(0, 0, 0, 0.1);
            max-width: 400px;
            margin: 100px auto;
            animation: slideIn 0.5s ease-out;
        }

        .main-dashboard {
            background: white;
            border-radius: 15px;
            box-shadow: 0 15px 35px rgba(0, 0, 0, 0.1);
            padding: 30px;
            animation: slideIn 0.5s ease-out;
        }

        @keyframes slideIn {
            from {
                opacity: 0;
                transform: translateY(30px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 30px;
            padding-bottom: 20px;
            border-bottom: 2px solid #f0f0f0;
        }

        .logo {
            font-size: 28px;
            font-weight: bold;
            color: #667eea;
        }

        .nursery-name {
            font-size: 18px;
            color: #555;
            margin-top: 5px;
        }

        .user-info {
            display: flex;
            align-items: center;
            gap: 15px;
        }

        .nav-menu {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .nav-button {
            padding: 20px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            border-radius: 10px;
            cursor: pointer;
            font-size: 16px;
            font-weight: 600;
            transition: all 0.3s ease;
            text-align: center;
        }

        .nav-button:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 25px rgba(102, 126, 234, 0.3);
        }

        .form-group {
            margin-bottom: 20px;
        }

        label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: #555;
        }

        input, select, textarea {
            width: 100%;
            padding: 12px;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            font-size: 14px;
            transition: border-color 0.3s ease;
        }

        input:focus, select:focus, textarea:focus {
            outline: none;
            border-color: #667eea;
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
        }

        .btn {
            padding: 12px 24px;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 600;
            transition: all 0.3s ease;
            margin-right: 10px;
            margin-bottom: 10px;
        }

        .btn-primary {
            background: #667eea;
            color: white;
        }

        .btn-success {
            background: #28a745;
            color: white;
        }

        .btn-danger {
            background: #dc3545;
            color: white;
        }

        .btn-secondary {
            background: #6c757d;
            color: white;
        }

        .btn:hover {
            transform: translateY(-1px);
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.2);
        }

        .table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 20px;
            background: white;
            border-radius: 10px;
            overflow: hidden;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.1);
        }

        .table th, .table td {
            padding: 15px;
            text-align: left;
            border-bottom: 1px solid #e0e0e0;
        }

        .table th {
            background: #f8f9fa;
            font-weight: 600;
            color: #555;
        }

        .table tr:hover {
            background: #f8f9fa;
        }

        .hidden {
            display: none !important;
        }

        .alert {
            padding: 15px;
            margin-bottom: 20px;
            border-radius: 8px;
            font-weight: 500;
        }

        .alert-success {
            background: #d4edda;
            border: 1px solid #c3e6cb;
            color: #155724;
        }

        .alert-error {
            background: #f8d7da;
            border: 1px solid #f5c6cb;
            color: #721c24;
        }

        .form-row {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
        }

        /* New Modal Style */
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 1000;
        }

        .modal-container {
            background: white;
            padding: 30px;
            border-radius: 15px;
            max-width: 600px;
            width: 90%;
            max-height: 90%;
            overflow-y: auto;
            position: relative;
        }

        .modal-close {
            position: absolute;
            top: 15px;
            right: 15px;
            font-size: 24px;
            cursor: pointer;
            color: #999;
            background: none;
            border: none;
        }

        .modal-header {
            margin-bottom: 20px;
            padding-bottom: 10px;
            border-bottom: 1px solid #e0e0e0;
        }

        .modal-footer {
            margin-top: 20px;
            padding-top: 10px;
            border-top: 1px solid #e0e0e0;
            display: flex;
            justify-content: flex-end;
        }

        /* Old Modal Style (kept for backward compatibility) */
        .modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 1000;
        }

        .modal-content {
            background: white;
            padding: 30px;
            border-radius: 15px;
            max-width: 600px;
            width: 90%;
            max-height: 90%;
            overflow-y: auto;
        }

        .close-modal {
            float: right;
            font-size: 24px;
            cursor: pointer;
            color: #999;
        }

        .status-badge {
            padding: 4px 12px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: 600;
        }

        .status-active {
            background: #d4edda;
            color: #155724;
        }

        .status-hold {
            background: #fff3cd;
            color: #856404;
        }

        .quick-stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .stat-card {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 25px;
            border-radius: 15px;
            text-align: center;
        }

        .stat-number {
            font-size: 32px;
            font-weight: bold;
            margin-bottom: 5px;
        }

        .stat-label {
            font-size: 14px;
            opacity: 0.9;
        }

        /* Student search dropdown */
        .search-dropdown {
            position: relative;
        }

        .search-results {
            position: absolute;
            top: 100%;
            left: 0;
            width: 100%;
            max-height: 200px;
            overflow-y: auto;
            background: white;
            border: 1px solid #e0e0e0;
            border-radius: 0 0 8px 8px;
            z-index: 10;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.1);
        }

        .search-item {
            padding: 10px 15px;
            cursor: pointer;
            transition: background 0.2s;
        }

        .search-item:hover {
            background: #f8f9fa;
        }

        .conditional-field {
            transition: all 0.3s ease;
        }

        /* Settings section styles */
        .settings-section {
            background: #f8f9fa;
            padding: 20px;
            border-radius: 10px;
            margin-bottom: 20px;
        }

        .settings-section h3 {
            margin-bottom: 15px;
            color: #555;
            border-bottom: 1px solid #e0e0e0;
            padding-bottom: 10px;
        }
        
        /* Error message style */
        .error-message {
            color: #dc3545;
            font-size: 12px;
            margin-top: 5px;
            display: none;
        }
    </style>
</head>
<body>
    <!-- Login Screen -->
    <div id="loginScreen">
        <div class="login-container">
            <h2 style="text-align: center; margin-bottom: 30px; color: #667eea;">Nursery Management System</h2>
            <div id="loginAlert"></div>
            <form id="loginForm">
                <div class="form-group">
                    <label for="username">Username</label>
                    <input type="text" id="username" name="username" required>
                </div>
                <div class="form-group">
                    <label for="password">Password</label>
                    <input type="password" id="password" name="password" required>
                </div>
                <button type="submit" class="btn btn-primary" style="width: 100%;">Login</button>
            </form>
        </div>
    </div>

    <!-- Main Dashboard -->
    <div id="mainDashboard" class="hidden">
        <div class="container">
            <div class="main-dashboard">
                <div class="header">
                    <div>
                        <div class="logo">üè´ Nursery Management</div>
                        <div class="nursery-name" id="nurseryNameDisplay">My Nursery</div>
                    </div>
                    <div class="user-info">
                        <span id="currentUser">Welcome, Admin</span>
                        <button class="btn btn-secondary" onclick="logout()">Logout</button>
                    </div>
                </div>

                <!-- Quick Stats -->
                <div id="dashboardView">
                    <div class="quick-stats">
                        <div class="stat-card">
                            <div class="stat-number" id="totalStudents">0</div>
                            <div class="stat-label">Total Students</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-number" id="monthlyIncome">$0</div>
                            <div class="stat-label">Monthly Income</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-number" id="monthlyExpenses">$0</div>
                            <div class="stat-label">Monthly Expenses</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-number" id="activeUsers">0</div>
                            <div class="stat-label">Active Users</div>
                        </div>
                    </div>

                    <div class="nav-menu">
                        <button class="nav-button" onclick="showView('studentsView')">üë• Student Management</button>
                        <button class="nav-button" onclick="showView('expensesView')">üí∞ Cash Management</button>
                        <button class="nav-button" onclick="showView('usersView')" id="userManagementBtn">üë§ User Management</button>
                        <button class="nav-button" onclick="showView('reportsView')">üìä Reports & Analytics</button>
                        <button class="nav-button" onclick="showView('settingsView')">‚öôÔ∏è System Settings</button>
                    </div>
                </div>

                <!-- Students Management View -->
                <div id="studentsView" class="hidden">
                    <div class="header">
                        <h2>Student Management</h2>
                        <div>
                            <button class="btn btn-success" onclick="showModal('addStudentModal')">Add New Student</button>
                            <button class="btn btn-secondary" onclick="showView('dashboardView')">Back to Dashboard</button>
                        </div>
                    </div>
                    <div id="studentsAlert"></div>
                    <table class="table" id="studentsTable">
                        <thead>
                            <tr>
                                <th>Name</th>
                                <th>Class</th>
                                <th>Join Date</th>
                                <th>Birthday</th>
                                <th>Status</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody></tbody>
                    </table>
                </div>

                <!-- Cash Management View (renamed from Expenses Management) -->
                <div id="expensesView" class="hidden">
                    <div class="header">
                        <h2>Cash Management</h2>
                        <div>
                            <button class="btn btn-success" onclick="showModal('addExpenseModal')">Add New Transaction</button>
                            <button class="btn btn-secondary" onclick="showView('dashboardView')">Back to Dashboard</button>
                        </div>
                    </div>
                    <div id="expensesAlert"></div>
                    <div class="form-row" style="margin-bottom: 20px;">
                        <div>
                            <label>Filter by Date Range:</label>
                            <div style="display: flex; gap: 10px;">
                                <input type="date" id="expenseFromDate">
                                <input type="date" id="expenseToDate">
                                <button class="btn btn-primary" onclick="filterExpenses()">Filter</button>
                            </div>
                        </div>
                        <div>
                            <label>Filter by Type:</label>
                            <select id="expenseTypeFilter" onchange="filterExpenses()">
                                <option value="">All Types</option>
                                <!-- This will be populated dynamically from system settings -->
                            </select>
                        </div>
                    </div>
                    <table class="table" id="expensesTable">
                        <thead>
                            <tr>
                                <th>Reference</th>
                                <th>Date</th>
                                <th>Type</th>
                                <th>Amount</th>
                                <th>Payment Method</th>
                                <th>In/Out</th>
                                <th>Source/Allocation</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody></tbody>
                    </table>
                </div>

                <!-- Users Management View -->
                <div id="usersView" class="hidden">
                    <div class="header">
                        <h2>User Management</h2>
                        <div>
                            <button class="btn btn-success" id="openAddUserBtn">Add New User</button>
                            <button class="btn btn-secondary" onclick="showView('dashboardView')">Back to Dashboard</button>
                        </div>
                    </div>
                    <div id="usersAlert"></div>
                    <table class="table" id="usersTable">
                        <thead>
                            <tr>
                                <th>Username</th>
                                <th>Role</th>
                                <th>Status</th>
                                <th>Created Date</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody></tbody>
                    </table>
                </div>

                <!-- Reports View -->
                <div id="reportsView" class="hidden">
                    <div class="header">
                        <h2>Reports & Analytics</h2>
                        <button class="btn btn-secondary" onclick="showView('dashboardView')">Back to Dashboard</button>
                    </div>
                    <div class="form-row" style="margin-bottom: 30px;">
                        <div class="form-group">
                            <label>From Date:</label>
                            <input type="date" id="reportFromDate">
                        </div>
                        <div class="form-group">
                            <label>To Date:</label>
                            <input type="date" id="reportToDate">
                        </div>
                    </div>
                    <div>
                        <button class="btn btn-primary" onclick="generateReport()">Generate Report</button>
                        <button class="btn btn-success" onclick="exportToExcel()">Export to Excel</button>
                    </div>
                    <div id="reportsAlert"></div>
                    <div id="reportContent" style="margin-top: 30px;"></div>
                </div>

                <!-- Settings View (Enhanced) -->
                <div id="settingsView" class="hidden">
                    <div class="header">
                        <h2>System Settings</h2>
                        <button class="btn btn-secondary" onclick="showView('dashboardView')">Back to Dashboard</button>
                    </div>
                    <div id="settingsAlert"></div>
                    
                    <!-- General Settings -->
                    <div class="settings-section">
                        <h3>General Settings</h3>
                        <div class="form-row">
                            <div class="form-group">
                                <label>Nursery Name:</label>
                                <input type="text" id="nurseryName" placeholder="Enter nursery name">
                            </div>
                            <div class="form-group">
                                <label>System Currency:</label>
                                <select id="systemCurrency">
                                    <option value="$">$ (USD)</option>
                                    <option value="‚Ç¨">‚Ç¨ (EUR)</option>
                                    <option value="¬£">¬£ (GBP)</option>
                                    <option value="¬•">¬• (JPY/CNY)</option>
                                    <option value="‚Çπ">‚Çπ (INR)</option>
                                    <option value="‚ÇΩ">‚ÇΩ (RUB)</option>
                                    <option value="‚Ç©">‚Ç© (KRW)</option>
                                    <option value="R$">R$ (BRL)</option>
                                    <option value="‚Ç∫">‚Ç∫ (TRY)</option>
                                    <option value="‚Ç¥">‚Ç¥ (UAH)</option>
                                    <option value="‚Ç¶">‚Ç¶ (NGN)</option>
                                    <option value="‚Ç±">‚Ç± (PHP)</option>
                                    <option value="‡∏ø">‡∏ø (THB)</option>
                                    <option value="‚Ç´">‚Ç´ (VND)</option>
                                    <option value="RM">RM (MYR)</option>
                                    <option value="‚Ç™">‚Ç™ (ILS)</option>
                                    <option value="SAR">SAR (Saudi Riyal)</option>
                                    <option value="AED">AED (UAE Dirham)</option>
                                    <option value="Custom">Custom</option>
                                </select>
                                <div id="customCurrencyContainer" class="hidden" style="margin-top: 10px;">
                                    <input type="text" id="customCurrency" placeholder="Enter custom currency symbol">
                                </div>
                            </div>
                        </div>
                        <div class="form-group">
                            <label>Closing Period Date:</label>
                            <input type="date" id="closingPeriodDate">
                            <p style="font-size: 12px; margin-top: 5px; color: #666;">
                                Transactions with dates on or before this date will be blocked
                            </p>
                        </div>
                        <button class="btn btn-primary" onclick="updateGeneralSettings()">Save General Settings</button>
                    </div>
                    
                    <!-- Reference Number Settings -->
                    <div class="settings-section">
                        <h3>Reference Number Settings</h3>
                        <div class="form-row">
                            <div class="form-group">
                                <label>Income Reference Starting Number:</label>
                                <div style="display: flex; align-items: center;">
                                    <span style="padding: 12px; background: #f0f0f0; border: 2px solid #e0e0e0; border-right: none; border-radius: 8px 0 0 8px;">IN-</span>
                                    <input type="number" id="incomeRefStart" min="1" value="1000" style="border-radius: 0 8px 8px 0;">
                                </div>
                            </div>
                            <div class="form-group">
                                <label>Expense Reference Starting Number:</label>
                                <div style="display: flex; align-items: center;">
                                    <span style="padding: 12px; background: #f0f0f0; border: 2px solid #e0e0e0; border-right: none; border-radius: 8px 0 0 8px;">EXP-</span>
                                    <input type="number" id="expenseRefStart" min="1" value="1000" style="border-radius: 0 8px 8px 0;">
                                </div>
                            </div>
                        </div>
                        <button class="btn btn-primary" onclick="updateReferenceSettings()">Save Reference Settings</button>
                    </div>
                    
                    <!-- Transaction Categories -->
                    <div class="settings-section">
                        <h3>Transaction Categories</h3>
                        <div class="form-row">
                            <div class="form-group">
                                <label>Income Categories:</label>
                                <textarea id="incomeCategories" rows="5" placeholder="Enter categories, one per line">Student Subscription
Meals Subscription
Late Club
Bus
Activity Club</textarea>
                            </div>
                            <div class="form-group">
                                <label>Expense Categories:</label>
                                <textarea id="expenseCategories" rows="5" placeholder="Enter categories, one per line">Salaries
Rent
Utilities
Supplies
Maintenance
Food
Transportation
Insurance
Taxes
Other</textarea>
                            </div>
                        </div>
                        <button class="btn btn-primary" onclick="updateCategories()">Save Categories</button>
                    </div>
                    
                    <!-- Payment Methods -->
                    <div class="settings-section">
                        <h3>Payment Methods</h3>
                        <div class="form-row">
                            <div class="form-group">
                                <label>Income Payment Methods:</label>
                                <textarea id="incomePaymentMethods" rows="3" placeholder="Enter payment methods, one per line">Cash
POS</textarea>
                            </div>
                            <div class="form-group">
                                <label>Expense Payment Methods:</label>
                                <textarea id="expensePaymentMethods" rows="3" placeholder="Enter payment methods, one per line">Cash
POS</textarea>
                            </div>
                        </div>
                        <button class="btn btn-primary" onclick="updatePaymentMethods()">Save Payment Methods</button>
                    </div>
                    
                    <!-- Data Backup -->
                    <div class="settings-section">
                        <h3>Data Management</h3>
                        <div class="form-group">
                            <label>Data Backup:</label>
                            <p style="margin-bottom: 10px;">Last backup: <span id="lastBackup">Never</span></p>
                            <button class="btn btn-primary" onclick="backupData()">Backup Now</button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Modals -->
    <!-- Add Student Modal -->
    <div id="addStudentModal" class="modal hidden">
        <div class="modal-content">
            <span class="close-modal" onclick="hideModal('addStudentModal')">&times;</span>
            <h3>Add New Student</h3>
            <form id="addStudentForm">
                <div class="form-row">
                    <div class="form-group">
                        <label>First Name *</label>
                        <input type="text" name="firstName" required>
                    </div>
                    <div class="form-group">
                        <label>Last Name *</label>
                        <input type="text" name="lastName" required>
                    </div>
                </div>
                <div class="form-row">
                    <div class="form-group">
                        <label>Birthday</label>
                        <input type="date" name="birthday">
                    </div>
                    <div class="form-group">
                        <label>Join Date *</label>
                        <input type="date" name="joinDate" required>
                        <div class="error-message" id="studentJoinDateError">Date cannot be on or before closing period</div>
                    </div>
                </div>
                <div class="form-group">
                    <label>Class *</label>
                    <select name="class" required>
                        <option value="">Select Class</option>
                        <option value="Nursery 1">Nursery 1</option>
                        <option value="Nursery 2">Nursery 2</option>
                        <option value="KG 1">KG 1</option>
                        <option value="KG 2">KG 2</option>
                    </select>
                </div>
                <div class="form-group">
                    <label>Allergic Notes</label>
                    <textarea name="allergicNotes" rows="3" placeholder="Any allergies or special notes..."></textarea>
                </div>
                <div class="form-group">
                    <label>Status</label>
                    <select name="status">
                        <option value="Active">Active</option>
                        <option value="On Hold">On Hold</option>
                    </select>
                </div>
                <button type="submit" class="btn btn-success">Add Student</button>
                <button type="button" class="btn btn-secondary" onclick="hideModal('addStudentModal')">Cancel</button>
            </form>
        </div>
    </div>

    <!-- Add Transaction Modal (Improved Flow) -->
    <div id="addExpenseModal" class="modal hidden">
        <div class="modal-content">
            <span class="close-modal" onclick="hideModal('addExpenseModal')">&times;</span>
            <h3>Add New Transaction</h3>
            <form id="addExpenseForm">
                <div class="form-row">
                    <div class="form-group">
                        <label>Reference Number</label>
                        <input type="text" name="reference" readonly>
                        <small>Auto-generated based on transaction type</small>
                    </div>
                    <div class="form-group">
                        <label>Date *</label>
                        <input type="date" name="date" required>
                        <div class="error-message" id="transactionDateError">Date cannot be on or before closing period</div>
                    </div>
                </div>
                
                <!-- Step 1: Select Transaction Type (Income/Expense) -->
                <div class="form-group">
                    <label>Transaction Type *</label>
                    <select name="inOut" required id="inOutSelect">
                        <option value="">Select Type</option>
                        <option value="In">Income</option>
                        <option value="Out">Expense</option>
                    </select>
                </div>
                
                <!-- Step 2: Select Category (based on Income/Expense) -->
                <div id="categoryContainer" class="conditional-field hidden">
                    <div class="form-group">
                        <label>Category *</label>
                        <select name="type" required id="transactionType">
                            <option value="">Select Category</option>
                            <!-- Will be populated dynamically based on Income/Expense selection -->
                        </select>
                    </div>
                </div>
                
                <!-- Step 3: Income Source (if Income selected) -->
                <div id="incomeSourceContainer" class="conditional-field hidden">
                    <div class="form-group">
                        <label>Income Source *</label>
                        <select name="incomeSource" id="incomeSourceSelect">
                            <option value="">Select Source</option>
                            <option value="Student">Student</option>
                            <option value="Bank">From Bank</option>
                            <option value="Staff">Staff Advance</option>
                            <option value="Other">Others</option>
                        </select>
                    </div>
                    
                    <!-- Student Search (if Student selected) -->
                    <div id="studentSearchContainer" class="conditional-field hidden">
                        <div class="form-group search-dropdown">
                            <label>Search Student *</label>
                            <input type="text" id="studentSearch" placeholder="Type student name..." autocomplete="off">
                            <input type="hidden" id="selectedStudentId" name="studentId">
                            <div id="searchResults" class="search-results hidden"></div>
                        </div>
                    </div>
                </div>
                
                <!-- Step 4: Amount -->
                <div class="form-group">
                    <label>Amount *</label>
                    <input type="number" name="amount" step="0.01" required>
                </div>
                
                <!-- Step 5: Payment Method -->
                <div class="form-group">
                    <label>Payment Method *</label>
                    <select name="paymentMethod" required id="paymentMethodSelect">
                        <option value="">Select Method</option>
                        <!-- Will be populated dynamically from system settings -->
                    </select>
                </div>
                
                <div class="form-group">
                    <label>Description</label>
                    <textarea name="description" rows="3" placeholder="Additional notes..."></textarea>
                </div>
                <button type="submit" class="btn btn-success">Add Transaction</button>
                <button type="button" class="btn btn-secondary" onclick="hideModal('addExpenseModal')">Cancel</button>
            </form>
        </div>
    </div>

    <!-- New Add User Modal (using different implementation) -->
    <div id="userModalOverlay" class="modal-overlay hidden">
        <div class="modal-container">
            <button class="modal-close" id="closeUserModal">&times;</button>
            <div class="modal-header">
                <h3 id="userModalTitle">Add New User</h3>
            </div>
            <div id="userModalAlert"></div>
            <form id="userForm">
                <input type="hidden" id="editUserId" value="">
                <div class="form-group">
                    <label for="userUsername">Username *</label>
                    <input type="text" id="userUsername" name="username" required>
                </div>
                <div class="form-group">
                    <label for="userPassword">Password *</label>
                    <input type="password" id="userPassword" name="password" required>
                </div>
                <div class="form-group">
                    <label for="userConfirmPassword">Confirm Password *</label>
                    <input type="password" id="userConfirmPassword" name="confirmPassword" required>
                </div>
                <div class="form-group">
                    <label for="userRole">Role *</label>
                    <select id="userRole" name="role" required>
                        <option value="">Select Role</option>
                        <option value="Admin">Admin</option>
                        <option value="Logger">Logger</option>
                    </select>
                </div>
                <div class="form-group">
                    <label for="userStatus">Status</label>
                    <select id="userStatus" name="status">
                        <option value="Active">Active</option>
                        <option value="On Hold">On Hold</option>
                    </select>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" id="cancelUserBtn">Cancel</button>
                    <button type="submit" class="btn btn-success" id="submitUserBtn">Add User</button>
                </div>
            </form>
        </div>
    </div>

    <script>
        // Application State
        let currentUser = null;
        let users = [
            { id: 1, username: 'admin', password: 'admin123', role: 'Admin', status: 'Active', createdDate: '2024-01-01' }
        ];
        let students = [];
        let expenses = [];
        
        // System Settings
        let systemSettings = {
            nurseryName: "My Nursery",
            currency: "$",
            closingPeriodDate: null,
            incomeRefStart: 1000,
            expenseRefStart: 1000,
            currentIncomeRef: 1000,
            currentExpenseRef: 1000,
            incomeCategories: [
                "Student Subscription",
                "Meals Subscription",
                "Late Club",
                "Bus",
                "Activity Club"
            ],
            expenseCategories: [
                "Salaries",
                "Rent",
                "Utilities",
                "Supplies",
                "Maintenance",
                "Food",
                "Transportation",
                "Insurance",
                "Taxes",
                "Other"
            ],
            incomePaymentMethods: [
                "Cash",
                "POS"
            ],
            expensePaymentMethods: [
                "Cash",
                "POS"
            ]
        };

        // Initialize Application
        document.addEventListener('DOMContentLoaded', function() {
            loadSampleData();
            updateDashboardStats();
            loadSystemSettings();
            
            // Set up event listeners for conditional fields
            document.getElementById('inOutSelect').addEventListener('change', handleTransactionTypeChange);
            document.getElementById('incomeSourceSelect').addEventListener('change', toggleStudentSearch);
            
            // Set up student search functionality
            const studentSearchInput = document.getElementById('studentSearch');
            studentSearchInput.addEventListener('input', function() {
                const searchTerm = this.value.toLowerCase();
                if (searchTerm.length < 2) {
                    document.getElementById('searchResults').classList.add('hidden');
                    return;
                }
                
                const filteredStudents = students.filter(student => 
                    `${student.firstName} ${student.lastName}`.toLowerCase().includes(searchTerm)
                );
                
                const resultsContainer = document.getElementById('searchResults');
                resultsContainer.innerHTML = '';
                
                if (filteredStudents.length > 0) {
                    filteredStudents.forEach(student => {
                        const item = document.createElement('div');
                        item.className = 'search-item';
                        item.textContent = `${student.firstName} ${student.lastName} (${student.class})`;
                        item.addEventListener('click', function() {
                            document.getElementById('selectedStudentId').value = student.id;
                            studentSearchInput.value = `${student.firstName} ${student.lastName}`;
                            resultsContainer.classList.add('hidden');
                        });
                        resultsContainer.appendChild(item);
                    });
                    resultsContainer.classList.remove('hidden');
                } else {
                    resultsContainer.classList.add('hidden');
                }
            });
            
            // Hide search results when clicking outside
            document.addEventListener('click', function(e) {
                if (!e.target.closest('.search-dropdown')) {
                    document.getElementById('searchResults').classList.add('hidden');
                }
            });
            
            // Initialize form event listeners
            document.getElementById('loginForm').addEventListener('submit', handleLogin);
            document.getElementById('addStudentForm').addEventListener('submit', handleAddStudentSubmit);
            document.getElementById('addExpenseForm').addEventListener('submit', handleAddExpenseSubmit);
            
            // Set up new user modal event listeners
            document.getElementById('openAddUserBtn').addEventListener('click', openUserModal);
            document.getElementById('closeUserModal').addEventListener('click', closeUserModal);
            document.getElementById('cancelUserBtn').addEventListener('click', closeUserModal);
            document.getElementById('userForm').addEventListener('submit', handleUserFormSubmit);
            
            // Set up date defaults
            const today = new Date().toISOString().split('T')[0];
            document.querySelectorAll('input[type="date"]').forEach(input => {
                if (!input.value) {
                    input.value = today;
                }
            });
            
            // Set up date validation for transaction form
            document.querySelector('#addExpenseForm input[name="date"]').addEventListener('change', validateTransactionDate);
            document.querySelector('#addStudentForm input[name="joinDate"]').addEventListener('change', validateStudentJoinDate);
            
            // Set up custom currency toggle
            document.getElementById('systemCurrency').addEventListener('change', function() {
                const customContainer = document.getElementById('customCurrencyContainer');
                if (this.value === 'Custom') {
                    customContainer.classList.remove('hidden');
                } else {
                    customContainer.classList.add('hidden');
                }
            });
        });

        // Format number with thousand separators
        function formatNumber(number) {
            return new Intl.NumberFormat('en-US').format(number);
        }

        // Load System Settings
        function loadSystemSettings() {
            // Update UI with system settings
            document.getElementById('nurseryName').value = systemSettings.nurseryName;
            document.getElementById('nurseryNameDisplay').textContent = systemSettings.nurseryName;
            
            // Set currency
            const currencySelect = document.getElementById('systemCurrency');
            if (systemSettings.currency && currencySelect.querySelector(`option[value="${systemSettings.currency}"]`)) {
                currencySelect.value = systemSettings.currency;
            } else {
                currencySelect.value = 'Custom';
                document.getElementById('customCurrencyContainer').classList.remove('hidden');
                document.getElementById('customCurrency').value = systemSettings.currency;
            }
            
            // Set closing period date
            if (systemSettings.closingPeriodDate) {
                document.getElementById('closingPeriodDate').value = systemSettings.closingPeriodDate;
            }
            
            // Set reference numbers
            document.getElementById('incomeRefStart').value = systemSettings.incomeRefStart;
            document.getElementById('expenseRefStart').value = systemSettings.expenseRefStart;
            
            // Set categories
            document.getElementById('incomeCategories').value = systemSettings.incomeCategories.join('\n');
            document.getElementById('expenseCategories').value = systemSettings.expenseCategories.join('\n');
            
            // Set payment methods
            document.getElementById('incomePaymentMethods').value = systemSettings.incomePaymentMethods.join('\n');
            document.getElementById('expensePaymentMethods').value = systemSettings.expensePaymentMethods.join('\n');
            
            // Populate filter dropdown
            const filterSelect = document.getElementById('expenseTypeFilter');
            filterSelect.innerHTML = '<option value="">All Types</option>';
            
            const allCategories = [...systemSettings.incomeCategories, ...systemSettings.expenseCategories];
            allCategories.forEach(category => {
                const option = document.createElement('option');
                option.value = category;
                option.textContent = category;
                filterSelect.appendChild(option);
            });
        }

        // Validate transaction date against closing period
        function validateTransactionDate() {
            const dateInput = document.querySelector('#addExpenseForm input[name="date"]');
            const errorElement = document.getElementById('transactionDateError');
            
            if (systemSettings.closingPeriodDate && dateInput.value <= systemSettings.closingPeriodDate) {
                errorElement.style.display = 'block';
                dateInput.setCustomValidity('Date cannot be on or before closing period');
            } else {
                errorElement.style.display = 'none';
                dateInput.setCustomValidity('');
            }
        }
        
        // Validate student join date against closing period
        function validateStudentJoinDate() {
            const dateInput = document.querySelector('#addStudentForm input[name="joinDate"]');
            const errorElement = document.getElementById('studentJoinDateError');
            
            if (systemSettings.closingPeriodDate && dateInput.value <= systemSettings.closingPeriodDate) {
                errorElement.style.display = 'block';
                dateInput.setCustomValidity('Date cannot be on or before closing period');
            } else {
                errorElement.style.display = 'none';
                dateInput.setCustomValidity('');
            }
        }

        // Handle Transaction Type Change
        function handleTransactionTypeChange() {
            const transactionType = document.getElementById('inOutSelect').value;
            const categoryContainer = document.getElementById('categoryContainer');
            const incomeSourceContainer = document.getElementById('incomeSourceContainer');
            const paymentMethodSelect = document.getElementById('paymentMethodSelect');
            const referenceInput = document.querySelector('input[name="reference"]');
            
            // Reset fields
            const transactionTypeSelect = document.getElementById('transactionType');
            transactionTypeSelect.innerHTML = '<option value="">Select Category</option>';
            paymentMethodSelect.innerHTML = '<option value="">Select Method</option>';
            
            if (transactionType === 'In') {
                // Show category selection and populate with income categories
                categoryContainer.classList.remove('hidden');
                systemSettings.incomeCategories.forEach(category => {
                    const option = document.createElement('option');
                    option.value = category;
                    option.textContent = category;
                    transactionTypeSelect.appendChild(option);
                });
                
                // Show income source
                incomeSourceContainer.classList.remove('hidden');
                
                // Generate income reference number
                referenceInput.value = `IN-${systemSettings.currentIncomeRef}`;
                
                // Populate payment methods with income payment methods
                systemSettings.incomePaymentMethods.forEach(method => {
                    const option = document.createElement('option');
                    option.value = method;
                    option.textContent = method;
                    paymentMethodSelect.appendChild(option);
                });
                
            } else if (transactionType === 'Out') {
                // Show category selection and populate with expense categories
                categoryContainer.classList.remove('hidden');
                systemSettings.expenseCategories.forEach(category => {
                    const option = document.createElement('option');
                    option.value = category;
                    option.textContent = category;
                    transactionTypeSelect.appendChild(option);
                });
                
                // Hide income source
                incomeSourceContainer.classList.add('hidden');
                
                // Generate expense reference number
                referenceInput.value = `EXP-${systemSettings.currentExpenseRef}`;
                
                // Populate payment methods with expense payment methods
                systemSettings.expensePaymentMethods.forEach(method => {
                    const option = document.createElement('option');
                    option.value = method;
                    option.textContent = method;
                    paymentMethodSelect.appendChild(option);
                });
                
                // Reset income source and student search
                document.getElementById('incomeSourceSelect').value = '';
                document.getElementById('studentSearchContainer').classList.add('hidden');
                document.getElementById('studentSearch').value = '';
                document.getElementById('selectedStudentId').value = '';
                
            } else {
                // Hide all conditional fields if no transaction type selected
                categoryContainer.classList.add('hidden');
                incomeSourceContainer.classList.add('hidden');
                referenceInput.value = '';
            }
            
            // Validate date after transaction type change
            validateTransactionDate();
        }
        
        // Toggle student search based on income source
        function toggleStudentSearch() {
            const incomeSource = document.getElementById('incomeSourceSelect').value;
            const studentSearchContainer = document.getElementById('studentSearchContainer');
            
            if (incomeSource === 'Student') {
                studentSearchContainer.classList.remove('hidden');
            } else {
                studentSearchContainer.classList.add('hidden');
                document.getElementById('studentSearch').value = '';
                document.getElementById('selectedStudentId').value = '';
            }
        }

        // Sample Data
        function loadSampleData() {
            students = [
                { id: 1, firstName: 'John', lastName: 'Doe', birthday: '2020-05-15', joinDate: '2024-01-10', class: 'Nursery 1', allergicNotes: 'None', status: 'Active' },
                { id: 2, firstName: 'Sarah', lastName: 'Smith', birthday: '2019-08-22', joinDate: '2024-01-15', class: 'KG 1', allergicNotes: 'Peanut allergy', status: 'Active' },
                { id: 3, firstName: 'Mike', lastName: 'Johnson', birthday: '2020-12-03', joinDate: '2024-02-01', class: 'Nursery 2', allergicNotes: 'None', status: 'On Hold' }
            ];

            expenses = [
                { id: 1, reference: 'IN-1000', date: '2024-05-01', type: 'Student Subscription', amount: 500, paymentMethod: 'Cash', inOut: 'In', description: 'Monthly fee', source: 'Student', studentId: 1 },
                { id: 2, reference: 'EXP-1000', date: '2024-05-02', type: 'Supplies', amount: 150, paymentMethod: 'Cash', inOut: 'Out', description: 'Cleaning supplies' },
                { id: 3, reference: 'IN-1001', date: '2024-05-03', type: 'Meals Subscription', amount: 200, paymentMethod: 'POS', inOut: 'In', description: 'Meal plan', source: 'Bank' }
            ];
            
            // Update reference counters
            systemSettings.currentIncomeRef = 1002;
            systemSettings.currentExpenseRef = 1001;
        }

        // Authentication
        function handleLogin(e) {
            e.preventDefault();
            const username = document.getElementById('username').value;
            const password = document.getElementById('password').value;
            
            const user = users.find(u => u.username === username && u.password === password && u.status === 'Active');
            
            if (user) {
                currentUser = user;
                document.getElementById('currentUser').textContent = `Welcome, ${user.username} (${user.role})`;
                document.getElementById('loginScreen').classList.add('hidden');
                document.getElementById('mainDashboard').classList.remove('hidden');
                
                // Hide user management for non-admin users
                if (user.role !== 'Admin') {
                    document.getElementById('userManagementBtn').style.display = 'none';
                }
                
                updateDashboardStats();
                showAlert('loginAlert', 'Login successful!', 'success');
            } else {
                showAlert('loginAlert', 'Invalid username or password!', 'error');
            }
        }

        function logout() {
            currentUser = null;
            document.getElementById('loginScreen').classList.remove('hidden');
            document.getElementById('mainDashboard').classList.add('hidden');
            document.getElementById('loginForm').reset();
            showView('dashboardView');
        }

        // Navigation
        function showView(viewId) {
            const views = ['dashboardView', 'studentsView', 'expensesView', 'usersView', 'reportsView', 'settingsView'];
            views.forEach(view => {
                document.getElementById(view).classList.add('hidden');
            });
            document.getElementById(viewId).classList.remove('hidden');
            
            if (viewId === 'studentsView') loadStudentsTable();
            if (viewId === 'expensesView') loadExpensesTable();
            if (viewId === 'usersView') loadUsersTable();
        }

        // Modal Functions
        function showModal(modalId) {
            document.getElementById(modalId).classList.remove('hidden');
            
            // Special handling for expense modal
            if (modalId === 'addExpenseModal') {
                // Reset form
                document.getElementById('addExpenseForm').reset();
                
                // Set default date
                const dateInput = document.querySelector('#addExpenseForm input[name="date"]');
                if (!dateInput.value) {
                    dateInput.value = new Date().toISOString().split('T')[0];
                }
                
                // Reset conditional fields
                document.getElementById('categoryContainer').classList.add('hidden');
                document.getElementById('incomeSourceContainer').classList.add('hidden');
                document.getElementById('studentSearchContainer').classList.add('hidden');
                
                // Validate date
                validateTransactionDate();
            }
            
            // Special handling for student modal
            if (modalId === 'addStudentModal') {
                // Reset form
                document.getElementById('addStudentForm').reset();
                
                // Set default date
                const joinDateInput = document.querySelector('#addStudentForm input[name="joinDate"]');
                if (!joinDateInput.value) {
                    joinDateInput.value = new Date().toISOString().split('T')[0];
                }
                
                // Validate date
                validateStudentJoinDate();
            }
        }

        function hideModal(modalId) {
            document.getElementById(modalId).classList.add('hidden');
            
            // Reset form when modal is closed
            const modal = document.getElementById(modalId);
            const form = modal.querySelector('form');
            if (form) {
                form.reset();
                form.removeAttribute('data-edit-id');
                // Reset form titles and button text
                const modalTitle = modal.querySelector('h3');
                const submitBtn = modal.querySelector('button[type="submit"]');
                if (modalId === 'addStudentModal') {
                    modalTitle.textContent = 'Add New Student';
                    submitBtn.textContent = 'Add Student';
                    document.getElementById('studentJoinDateError').style.display = 'none';
                } else if (modalId === 'addExpenseModal') {
                    modalTitle.textContent = 'Add New Transaction';
                    submitBtn.textContent = 'Add Transaction';
                    // Reset conditional fields
                    document.getElementById('categoryContainer').classList.add('hidden');
                    document.getElementById('incomeSourceContainer').classList.add('hidden');
                    document.getElementById('studentSearchContainer').classList.add('hidden');
                    document.getElementById('transactionDateError').style.display = 'none';
                }
            }
        }

        // New User Modal Functions
        function openUserModal(userId = null) {
            // Reset form
            document.getElementById('userForm').reset();
            document.getElementById('editUserId').value = '';
            document.getElementById('userModalTitle').textContent = 'Add New User';
            document.getElementById('submitUserBtn').textContent = 'Add User';
            
            // If editing existing user
            if (userId) {
                const user = users.find(u => u.id === userId);
                if (user) {
                    document.getElementById('editUserId').value = userId;
                    document.getElementById('userUsername').value = user.username;
                    document.getElementById('userPassword').value = user.password;
                    document.getElementById('userConfirmPassword').value = user.password;
                    document.getElementById('userRole').value = user.role;
                    document.getElementById('userStatus').value = user.status;
                    
                    document.getElementById('userModalTitle').textContent = 'Edit User';
                    document.getElementById('submitUserBtn').textContent = 'Update User';
                }
            }
            
            // Show modal
            document.getElementById('userModalOverlay').classList.remove('hidden');
        }
        
        function closeUserModal() {
            document.getElementById('userModalOverlay').classList.add('hidden');
            document.getElementById('userForm').reset();
        }
        
        function handleUserFormSubmit(e) {
            e.preventDefault();
            
            // Get form values
            const username = document.getElementById('userUsername').value;
            const password = document.getElementById('userPassword').value;
            const confirmPassword = document.getElementById('userConfirmPassword').value;
            const role = document.getElementById('userRole').value;
            const status = document.getElementById('userStatus').value;
            const editId = document.getElementById('editUserId').value;
            
            // Validate password match
            if (password !== confirmPassword) {
                showAlert('userModalAlert', 'Passwords do not match!', 'error');
                return;
            }
            
            // Check if username already exists (for new users)
            if (!editId && users.find(u => u.username === username)) {
                showAlert('userModalAlert', 'Username already exists!', 'error');
                return;
            }
            
            if (editId) {
                // Update existing user
                const userIndex = users.findIndex(u => u.id === parseInt(editId));
                if (userIndex !== -1) {
                    users[userIndex] = {
                        ...users[userIndex],
                        username: username,
                        password: password,
                        role: role,
                        status: status
                    };
                }
                showAlert('usersAlert', 'User updated successfully!', 'success');
            } else {
                // Add new user
                const userData = {
                    id: Date.now(),
                    username: username,
                    password: password,
                    role: role,
                    status: status,
                    createdDate: new Date().toISOString().split('T')[0]
                };
                users.push(userData);
                showAlert('usersAlert', 'User added successfully!', 'success');
            }
            
            // Update UI and close modal
            loadUsersTable();
            updateDashboardStats();
            closeUserModal();
        }

        // Alert Functions
        function showAlert(containerId, message, type) {
            const container = document.getElementById(containerId);
            container.innerHTML = `<div class="alert alert-${type}">${message}</div>`;
            setTimeout(() => {
                container.innerHTML = '';
            }, 5000);
        }

        // Dashboard Stats
        function updateDashboardStats() {
            document.getElementById('totalStudents').textContent = formatNumber(students.filter(s => s.status === 'Active').length);
            
            const currentMonth = new Date().getMonth();
            const currentYear = new Date().getFullYear();
            
            const monthlyIncome = expenses
                .filter(e => e.inOut === 'In' && new Date(e.date).getMonth() === currentMonth && new Date(e.date).getFullYear() === currentYear)
                .reduce((sum, e) => sum + parseFloat(e.amount), 0);
            
            const monthlyExpenseAmount = expenses
                .filter(e => e.inOut === 'Out' && new Date(e.date).getMonth() === currentMonth && new Date(e.date).getFullYear() === currentYear)
                .reduce((sum, e) => sum + parseFloat(e.amount), 0);
            
            document.getElementById('monthlyIncome').textContent = `${systemSettings.currency}${formatNumber(monthlyIncome.toFixed(2))}`;
            document.getElementById('monthlyExpenses').textContent = `${systemSettings.currency}${formatNumber(monthlyExpenseAmount.toFixed(2))}`;
            document.getElementById('activeUsers').textContent = formatNumber(users.filter(u => u.status === 'Active').length);
        }

        // Student Management
        function loadStudentsTable() {
            const tbody = document.querySelector('#studentsTable tbody');
            tbody.innerHTML = '';
            
            students.forEach(student => {
                const row = tbody.insertRow();
                row.innerHTML = `
                    <td>${student.firstName} ${student.lastName}</td>
                    <td>${student.class}</td>
                    <td>${student.joinDate}</td>
                    <td>${student.birthday}</td>
                    <td><span class="status-badge status-${student.status.toLowerCase().replace(' ', '-')}">${student.status}</span></td>
                    <td>
                        <button class="btn btn-primary" onclick="editStudent(${student.id})">Edit</button>
                        <button class="btn btn-danger" onclick="deleteStudent(${student.id})">Delete</button>
                    </td>
                `;
            });
        }

        function handleAddStudentSubmit(e) {
            e.preventDefault();
            const formData = new FormData(e.target);
            const editId = e.target.getAttribute('data-edit-id');
            
            // Validate join date against closing period
            const joinDate = formData.get('joinDate');
            if (systemSettings.closingPeriodDate && joinDate <= systemSettings.closingPeriodDate) {
                showAlert('studentsAlert', 'Join date cannot be on or before closing period!', 'error');
                return;
            }
            
            const studentData = {
                id: editId ? parseInt(editId) : Date.now(),
                firstName: formData.get('firstName'),
                lastName: formData.get('lastName'),
                birthday: formData.get('birthday'),
                joinDate: joinDate,
                class: formData.get('class'),
                allergicNotes: formData.get('allergicNotes'),
                status: formData.get('status')
            };
            
            if (editId) {
                // Update existing student
                const studentIndex = students.findIndex(s => s.id === parseInt(editId));
                if (studentIndex !== -1) {
                    students[studentIndex] = studentData;
                }
                e.target.removeAttribute('data-edit-id');
                document.querySelector('#addStudentModal h3').textContent = 'Add New Student';
                document.querySelector('#addStudentModal button[type="submit"]').textContent = 'Add Student';
                showAlert('studentsAlert', 'Student updated successfully!', 'success');
            } else {
                // Add new student
                students.push(studentData);
                showAlert('studentsAlert', 'Student added successfully!', 'success');
            }
            
            loadStudentsTable();
            updateDashboardStats();
            hideModal('addStudentModal');
            e.target.reset();
        }

        function editStudent(id) {
            const student = students.find(s => s.id === id);
            if (student) {
                // Pre-fill form with student data
                const form = document.getElementById('addStudentForm');
                form.elements.firstName.value = student.firstName;
                form.elements.lastName.value = student.lastName;
                form.elements.birthday.value = student.birthday;
                form.elements.joinDate.value = student.joinDate;
                form.elements.class.value = student.class;
                form.elements.allergicNotes.value = student.allergicNotes;
                form.elements.status.value = student.status;
                
                form.setAttribute('data-edit-id', id);
                document.querySelector('#addStudentModal h3').textContent = 'Edit Student';
                document.querySelector('#addStudentModal button[type="submit"]').textContent = 'Update Student';
                
                // Validate join date
                validateStudentJoinDate();
                
                showModal('addStudentModal');
            }
        }

        function deleteStudent(id) {
            // Check if user has permission to delete
            if (currentUser.role === 'Logger') {
                showAlert('studentsAlert', 'Logger users do not have permission to delete records!', 'error');
                return;
            }
            
            if (confirm('Are you sure you want to delete this student?')) {
                students = students.filter(s => s.id !== id);
                loadStudentsTable();
                updateDashboardStats();
                showAlert('studentsAlert', 'Student deleted successfully!', 'success');
            }
        }

        // Expense Management
        function loadExpensesTable(filteredData = null) {
            const tbody = document.querySelector('#expensesTable tbody');
            tbody.innerHTML = '';
            
            const data = filteredData || expenses;
            
            data.forEach(expense => {
                const row = tbody.insertRow();
                
                // Get source/allocation information
                let sourceAllocation = '';
                if (expense.inOut === 'In') {
                    if (expense.source === 'Student' && expense.studentId) {
                        const student = students.find(s => s.id === expense.studentId);
                        sourceAllocation = student ? `${student.firstName} ${student.lastName}` : 'Unknown Student';
                    } else {
                        sourceAllocation = expense.source || '';
                    }
                } else {
                    sourceAllocation = expense.type || '';
                }
                
                // Check if transaction is on or before closing period
                const isBeforeClosingPeriod = systemSettings.closingPeriodDate && expense.date <= systemSettings.closingPeriodDate;
                
                // Determine if edit/delete buttons should be shown based on user role and closing period
                let actionButtons = '';
                if (currentUser.role === 'Admin' || (currentUser.role === 'Logger' && !isBeforeClosingPeriod)) {
                    actionButtons += `<button class="btn btn-primary" onclick="editExpense(${expense.id})">Edit</button>`;
                }
                
                if (currentUser.role === 'Admin') {
                    actionButtons += `<button class="btn btn-danger" onclick="deleteExpense(${expense.id})">Delete</button>`;
                }
                
                if (actionButtons === '') {
                    actionButtons = '<span style="color: #999;">No actions available</span>';
                }
                
                row.innerHTML = `
                    <td>${expense.reference}</td>
                    <td>${expense.date}</td>
                    <td>${expense.type}</td>
                    <td>${systemSettings.currency}${formatNumber(parseFloat(expense.amount).toFixed(2))}</td>
                    <td>${expense.paymentMethod}</td>
                    <td><span style="color: ${expense.inOut === 'In' ? 'green' : 'red'}">${expense.inOut === 'In' ? 'Income' : 'Expense'}</span></td>
                    <td>${sourceAllocation}</td>
                    <td>${actionButtons}</td>
                `;
            });
        }

        function handleAddExpenseSubmit(e) {
            e.preventDefault();
            const formData = new FormData(e.target);
            const editId = e.target.getAttribute('data-edit-id');
            
            // Validate transaction date against closing period
            const transactionDate = formData.get('date');
            if (systemSettings.closingPeriodDate && transactionDate <= systemSettings.closingPeriodDate) {
                showAlert('expensesAlert', 'Transaction date cannot be on or before closing period!', 'error');
                return;
            }
            
            // Get basic transaction data
            const transactionData = {
                id: editId ? parseInt(editId) : Date.now(),
                reference: formData.get('reference'),
                date: transactionDate,
                type: formData.get('type'),
                amount: parseFloat(formData.get('amount')),
                paymentMethod: formData.get('paymentMethod'),
                inOut: formData.get('inOut'),
                description: formData.get('description')
            };
            
            // Add source/allocation based on transaction type
            if (transactionData.inOut === 'In') {
                transactionData.source = formData.get('incomeSource');
                if (transactionData.source === 'Student') {
                    transactionData.studentId = parseInt(document.getElementById('selectedStudentId').value);
                }
                
                // Increment income reference counter
                if (!editId) {
                    systemSettings.currentIncomeRef++;
                }
            } else if (transactionData.inOut === 'Out') {
                // Increment expense reference counter
                if (!editId) {
                    systemSettings.currentExpenseRef++;
                }
            }
            
            if (editId) {
                // Update existing expense
                const expenseIndex = expenses.findIndex(e => e.id === parseInt(editId));
                if (expenseIndex !== -1) {
                    expenses[expenseIndex] = transactionData;
                }
                e.target.removeAttribute('data-edit-id');
                document.querySelector('#addExpenseModal h3').textContent = 'Add New Transaction';
                document.querySelector('#addExpenseModal button[type="submit"]').textContent = 'Add Transaction';
                showAlert('expensesAlert', 'Transaction updated successfully!', 'success');
            } else {
                // Add new expense
                expenses.push(transactionData);
                showAlert('expensesAlert', 'Transaction added successfully!', 'success');
            }
            
            loadExpensesTable();
            updateDashboardStats();
            hideModal('addExpenseModal');
            e.target.reset();
            
            // Reset conditional fields
            document.getElementById('categoryContainer').classList.add('hidden');
            document.getElementById('incomeSourceContainer').classList.add('hidden');
            document.getElementById('studentSearchContainer').classList.add('hidden');
        }

        function editExpense(id) {
            const expense = expenses.find(e => e.id === id);
            if (expense) {
                // Check if transaction is on or before closing period and user is Logger
                if (currentUser.role === 'Logger' && systemSettings.closingPeriodDate && expense.date <= systemSettings.closingPeriodDate) {
                    showAlert('expensesAlert', 'Logger users cannot edit transactions on or before the closing period!', 'error');
                    return;
                }
                
                const form = document.getElementById('addExpenseForm');
                form.elements.reference.value = expense.reference;
                form.elements.date.value = expense.date;
                form.elements.inOut.value = expense.inOut;
                
                // Trigger transaction type change to populate categories
                handleTransactionTypeChange();
                
                // Set category
                form.elements.type.value = expense.type;
                form.elements.amount.value = expense.amount;
                form.elements.paymentMethod.value = expense.paymentMethod;
                form.elements.description.value = expense.description || '';
                
                // Handle conditional fields
                if (expense.inOut === 'In') {
                    document.getElementById('incomeSourceContainer').classList.remove('hidden');
                    
                    if (expense.source) {
                        document.getElementById('incomeSourceSelect').value = expense.source;
                        
                        if (expense.source === 'Student' && expense.studentId) {
                            document.getElementById('studentSearchContainer').classList.remove('hidden');
                            const student = students.find(s => s.id === expense.studentId);
                            if (student) {
                                document.getElementById('studentSearch').value = `${student.firstName} ${student.lastName}`;
                                document.getElementById('selectedStudentId').value = student.id;
                            }
                        }
                    }
                } else if (expense.inOut === 'Out') {
                    document.getElementById('incomeSourceContainer').classList.add('hidden');
                    document.getElementById('studentSearchContainer').classList.add('hidden');
                }
                
                form.setAttribute('data-edit-id', id);
                document.querySelector('#addExpenseModal h3').textContent = 'Edit Transaction';
                document.querySelector('#addExpenseModal button[type="submit"]').textContent = 'Update Transaction';
                
                // Validate date
                validateTransactionDate();
                
                showModal('addExpenseModal');
            }
        }

        function deleteExpense(id) {
            // Check if user has permission to delete
            if (currentUser.role === 'Logger') {
                showAlert('expensesAlert', 'Logger users do not have permission to delete records!', 'error');
                return;
            }
            
            if (confirm('Are you sure you want to delete this transaction?')) {
                expenses = expenses.filter(e => e.id !== id);
                loadExpensesTable();
                updateDashboardStats();
                showAlert('expensesAlert', 'Transaction deleted successfully!', 'success');
            }
        }

        function filterExpenses() {
            const fromDate = document.getElementById('expenseFromDate').value;
            const toDate = document.getElementById('expenseToDate').value;
            const type = document.getElementById('expenseTypeFilter').value;
            
            let filteredData = expenses;
            
            if (fromDate) {
                filteredData = filteredData.filter(e => e.date >= fromDate);
            }
            
            if (toDate) {
                filteredData = filteredData.filter(e => e.date <= toDate);
            }
            
            if (type) {
                filteredData = filteredData.filter(e => e.type === type);
            }
            
            loadExpensesTable(filteredData);
        }

        // User Management
        function loadUsersTable() {
            const tbody = document.querySelector('#usersTable tbody');
            tbody.innerHTML = '';
            
            users.forEach(user => {
                const row = tbody.insertRow();
                row.innerHTML = `
                    <td>${user.username}</td>
                    <td>${user.role}</td>
                    <td><span class="status-badge status-${user.status.toLowerCase().replace(' ', '-')}">${user.status}</span></td>
                    <td>${user.createdDate}</td>
                    <td>
                        <button class="btn btn-primary" onclick="editUser(${user.id})">Edit</button>
                        <button class="btn btn-danger" onclick="deleteUser(${user.id})">Delete</button>
                        <button class="btn btn-secondary" onclick="toggleUserStatus(${user.id})">${user.status === 'Active' ? 'Deactivate' : 'Activate'}</button>
                    </td>
                `;
            });
        }

        function editUser(id) {
            openUserModal(id);
        }

        function deleteUser(id) {
            if (id === 1) {
                showAlert('usersAlert', 'Cannot delete the main admin user!', 'error');
                return;
            }
            if (confirm('Are you sure you want to delete this user?')) {
                users = users.filter(u => u.id !== id);
                loadUsersTable();
                updateDashboardStats();
                showAlert('usersAlert', 'User deleted successfully!', 'success');
            }
        }

        function toggleUserStatus(id) {
            const user = users.find(u => u.id === id);
            if (user) {
                user.status = user.status === 'Active' ? 'On Hold' : 'Active';
                loadUsersTable();
                updateDashboardStats();
                showAlert('usersAlert', `User status changed to ${user.status}!`, 'success');
            }
        }

        // Reports
        function generateReport() {
            const fromDate = document.getElementById('reportFromDate').value;
            const toDate = document.getElementById('reportToDate').value;
            
            if (!fromDate || !toDate) {
                showAlert('reportsAlert', 'Please select both from and to dates!', 'error');
                return;
            }
            
            const filteredExpenses = expenses.filter(e => e.date >= fromDate && e.date <= toDate);
            
            const totalIncome = filteredExpenses.filter(e => e.inOut === 'In').reduce((sum, e) => sum + parseFloat(e.amount), 0);
            const totalExpenses = filteredExpenses.filter(e => e.inOut === 'Out').reduce((sum, e) => sum + parseFloat(e.amount), 0);
            const netProfit = totalIncome - totalExpenses;
            
            const reportContent = document.getElementById('reportContent');
            reportContent.innerHTML = `
                <div style="background: #f8f9fa; padding: 20px; border-radius: 10px; margin-bottom: 20px;">
                    <h3>Financial Report (${fromDate} to ${toDate})</h3>
                    <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 20px; margin-top: 20px;">
                        <div style="text-align: center;">
                            <h4 style="color: green;">Total Income</h4>
                            <p style="font-size: 24px; font-weight: bold;">${systemSettings.currency}${formatNumber(totalIncome.toFixed(2))}</p>
                        </div>
                        <div style="text-align: center;">
                            <h4 style="color: red;">Total Expenses</h4>
                            <p style="font-size: 24px; font-weight: bold;">${systemSettings.currency}${formatNumber(totalExpenses.toFixed(2))}</p>
                        </div>
                        <div style="text-align: center;">
                            <h4 style="color: ${netProfit >= 0 ? 'green' : 'red'};">Net Profit</h4>
                            <p style="font-size: 24px; font-weight: bold;">${systemSettings.currency}${formatNumber(netProfit.toFixed(2))}</p>
                        </div>
                    </div>
                </div>
                <table class="table">
                    <thead>
                        <tr>
                            <th>Reference</th>
                            <th>Date</th>
                            <th>Type</th>
                            <th>Amount</th>
                            <th>Payment Method</th>
                            <th>In/Out</th>
                            <th>Source/Allocation</th>
                        </tr>
                    </thead>
                    <tbody>
                        ${filteredExpenses.map(expense => {
                            // Get source/allocation information
                            let sourceAllocation = '';
                            if (expense.inOut === 'In') {
                                if (expense.source === 'Student' && expense.studentId) {
                                    const student = students.find(s => s.id === expense.studentId);
                                    sourceAllocation = student ? `${student.firstName} ${student.lastName}` : 'Unknown Student';
                                } else {
                                    sourceAllocation = expense.source || '';
                                }
                            } else {
                                sourceAllocation = expense.type || '';
                            }
                            
                            return `
                                <tr>
                                    <td>${expense.reference}</td>
                                    <td>${expense.date}</td>
                                    <td>${expense.type}</td>
                                    <td>${systemSettings.currency}${formatNumber(parseFloat(expense.amount).toFixed(2))}</td>
                                    <td>${expense.paymentMethod}</td>
                                    <td><span style="color: ${expense.inOut === 'In' ? 'green' : 'red'}">${expense.inOut === 'In' ? 'Income' : 'Expense'}</span></td>
                                    <td>${sourceAllocation}</td>
                                </tr>
                            `;
                        }).join('')}
                    </tbody>
                </table>
            `;
        }

        function exportToExcel() {
            const fromDate = document.getElementById('reportFromDate').value;
            const toDate = document.getElementById('reportToDate').value;
            
            if (!fromDate || !toDate) {
                showAlert('reportsAlert', 'Please generate a report first!', 'error');
                return;
            }
            
            const filteredExpenses = expenses.filter(e => e.date >= fromDate && e.date <= toDate);
            
            let csvContent = "Reference,Date,Type,Amount,Payment Method,In/Out,Source/Allocation,Description\n";
            filteredExpenses.forEach(expense => {
                // Get source/allocation information
                let sourceAllocation = '';
                if (expense.inOut === 'In') {
                    if (expense.source === 'Student' && expense.studentId) {
                        const student = students.find(s => s.id === expense.studentId);
                        sourceAllocation = student ? `${student.firstName} ${student.lastName}` : 'Unknown Student';
                    } else {
                        sourceAllocation = expense.source || '';
                    }
                } else {
                    sourceAllocation = expense.type || '';
                }
                
                csvContent += `${expense.reference},${expense.date},${expense.type},${expense.amount},${expense.paymentMethod},${expense.inOut === 'In' ? 'Income' : 'Expense'},"${sourceAllocation}","${expense.description || ''}"\n`;
            });
            
            const blob = new Blob([csvContent], { type: 'text/csv' });
            const url = window.URL.createObjectURL(blob);
            const link = document.createElement('a');
            link.href = url;
            link.download = `nursery_report_${fromDate}_to_${toDate}.csv`;
            link.click();
            window.URL.revokeObjectURL(url);
        }

        // Settings Functions
        function updateGeneralSettings() {
            const name = document.getElementById('nurseryName').value;
            const closingDate = document.getElementById('closingPeriodDate').value;
            
            // Get currency
            let currency = document.getElementById('systemCurrency').value;
            if (currency === 'Custom') {
                currency = document.getElementById('customCurrency').value || '$';
            }
            
            if (name) {
                systemSettings.nurseryName = name;
                document.getElementById('nurseryNameDisplay').textContent = name;
            }
            
            systemSettings.currency = currency;
            systemSettings.closingPeriodDate = closingDate;
            
            updateDashboardStats();
            showAlert('settingsAlert', 'General settings updated successfully!', 'success');
        }

        function updateReferenceSettings() {
            const incomeRefStart = parseInt(document.getElementById('incomeRefStart').value);
            const expenseRefStart = parseInt(document.getElementById('expenseRefStart').value);
            
            if (incomeRefStart && expenseRefStart) {
                systemSettings.incomeRefStart = incomeRefStart;
                systemSettings.expenseRefStart = expenseRefStart;
                
                // Only update current counters if they are less than the new starting values
                if (systemSettings.currentIncomeRef < incomeRefStart) {
                    systemSettings.currentIncomeRef = incomeRefStart;
                }
                
                if (systemSettings.currentExpenseRef < expenseRefStart) {
                    systemSettings.currentExpenseRef = expenseRefStart;
                }
                
                showAlert('settingsAlert', 'Reference number settings updated successfully!', 'success');
            }
        }
        
        function updateCategories() {
            const incomeCategories = document.getElementById('incomeCategories').value.split('\n').filter(cat => cat.trim() !== '');
            const expenseCategories = document.getElementById('expenseCategories').value.split('\n').filter(cat => cat.trim() !== '');
            
            if (incomeCategories.length > 0 && expenseCategories.length > 0) {
                systemSettings.incomeCategories = incomeCategories;
                systemSettings.expenseCategories = expenseCategories;
                
                // Update filter dropdown
                const filterSelect = document.getElementById('expenseTypeFilter');
                filterSelect.innerHTML = '<option value="">All Types</option>';
                
                const allCategories = [...incomeCategories, ...expenseCategories];
                allCategories.forEach(category => {
                    const option = document.createElement('option');
                    option.value = category;
                    option.textContent = category;
                    filterSelect.appendChild(option);
                });
                
                showAlert('settingsAlert', 'Transaction categories updated successfully!', 'success');
            }
        }
        
        function updatePaymentMethods() {
            const incomePaymentMethods = document.getElementById('incomePaymentMethods').value.split('\n').filter(method => method.trim() !== '');
            const expensePaymentMethods = document.getElementById('expensePaymentMethods').value.split('\n').filter(method => method.trim() !== '');
            
            if (incomePaymentMethods.length > 0 && expensePaymentMethods.length > 0) {
                systemSettings.incomePaymentMethods = incomePaymentMethods;
                systemSettings.expensePaymentMethods = expensePaymentMethods;
                
                showAlert('settingsAlert', 'Payment methods updated successfully!', 'success');
            }
        }

        function backupData() {
            const data = {
                nurseryName: systemSettings.nurseryName,
                currency: systemSettings.currency,
                users: users,
                students: students,
                expenses: expenses,
                closingPeriodDate: systemSettings.closingPeriodDate,
                systemSettings: systemSettings,
                backupDate: new Date().toISOString()
            };
            
            const blob = new Blob([JSON.stringify(data, null, 2)], { type: 'application/json' });
            const url = window.URL.createObjectURL(blob);
            const link = document.createElement('a');
            link.href = url;
            link.download = `nursery_backup_${new Date().toISOString().split('T')[0]}.json`;
            link.click();
            window.URL.revokeObjectURL(url);
            
            document.getElementById('lastBackup').textContent = new Date().toLocaleString();
            showAlert('settingsAlert', 'Data backup completed successfully!', 'success');
        }
    </script>
</body>
</html>
