<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Nursery Management System</title>
  <style>
    /* Modern, responsive styles omitted for brevity but included as in your original */
    /* ...full CSS same as your original, combines dashboard, navigation, tables, modals, alerts... */
  </style>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
</head>
<body>
<!-- Login Screen -->
<div id="loginScreen">
  <div class="login-container">
    <h2 style="text-align:center;color:#667eea;">Nursery Management System</h2>
    <div id="loginAlert"></div>
    <form id="loginForm">
      <div class="form-group"><label>Username</label><input type="text" id="username" required /></div>
      <div class="form-group"><label>Password</label><input type="password" id="password" required /></div>
      <button type="submit" class="btn btn-primary" style="width:100%;">Login</button>
    </form>
  </div>
</div>

<!-- Main Dashboard -->
<div id="mainDashboard" class="hidden">
  <div class="container main-dashboard">
    <div class="header">
      <div><span class="logo">Nursery Management</span><span id="nurseryNameDisplay"></span></div>
      <span class="datetime-display" id="currentDateTime"></span>
      <span id="currentUser"></span>
      <button class="btn btn-secondary" onclick="logout()">Logout</button>
    </div>
    <div id="dashboardView">
      <div class="quick-stats">
        <div class="stat-card"><div class="stat-number" id="totalStudents">0</div>Total Students</div>
        <div class="stat-card"><div class="stat-number" id="monthlyIncome">0</div>Monthly Income</div>
        <div class="stat-card"><div class="stat-number" id="monthlyExpenses">0</div>Monthly Expenses</div>
        <div class="stat-card"><div class="stat-number" id="activeUsers">0</div>Active Users</div>
      </div>
      <div class="nav-menu">
        <button class="nav-button" id="navStudents" onclick="showView('studentsView')">View Students</button>
        <button class="nav-button" id="navTransactions" onclick="showView('expensesView')">View Transactions</button>
        <button class="nav-button" id="navUsers" onclick="showView('usersView')">View Users</button>
        <button class="nav-button" id="navReports" onclick="showView('reportsView')">View Reports</button>
        <button class="nav-button" id="navSettings" onclick="showView('settingsView')">Settings</button>
      </div>
    </div>
  </div>
</div>
<!-- Students Management View -->
<div id="studentsView" class="hidden">
  <h3>Student Management</h3>
  <button class="btn btn-success" onclick="openStudentModal()">Add Student</button>
  <table class="table" id="studentsTable">
    <thead>
      <tr>
        <th>Name</th><th>Guardian</th><th>Mobile</th><th>Class</th><th>Join Date</th><th>Status</th><th>Actions</th>
      </tr>
    </thead>
    <tbody>
      <!-- Populated dynamically -->
    </tbody>
  </table>
</div>
<!-- Add/Edit Student Modal -->
<div id="studentModal" class="modal hidden">
  <div class="modal-content">
    <span class="close" onclick="closeStudentModal()">&times;</span>
    <h3 id="studentModalTitle">Add/Edit Student</h3>
    <form id="studentForm">
      <input type="hidden" id="studentId" />
      <div class="form-group"><label>Name</label><input type="text" id="studentName" required /></div>
      <div class="form-group"><label>Guardian</label><input type="text" id="studentGuardian" required /></div>
      <div class="form-group"><label>Mobile</label><input type="text" id="studentMobile" required /></div>
      <div class="form-group"><label>Class</label><input type="text" id="studentClass" /></div>
      <div class="form-group"><label>Join Date</label><input type="date" id="studentJoinDate" /></div>
      <div class="form-group"><label>Status</label>
        <select id="studentStatus">
          <option value="Active">Active</option>
          <option value="Left">Left</option>
        </select>
      </div>
      <button type="submit" class="btn btn-primary">Save</button>
    </form>
  </div>
</div>

<!-- Expenses/Transactions View -->
<div id="expensesView" class="hidden">
  <h3>Transaction Management</h3>
  <button class="btn btn-success" onclick="openExpenseModal()">Add Transaction</button>
  <table class="table" id="expensesTable">
    <thead>
      <tr>
        <th>Reference</th><th>Date</th><th>Type</th><th>Amount</th><th>In/Out</th><th>Description</th><th>Actions</th>
      </tr>
    </thead>
    <tbody>
      <!-- Populated dynamically -->
    </tbody>
  </table>
</div>
<!-- Add/Edit Expense Modal -->
<div id="expenseModal" class="modal hidden">
  <div class="modal-content">
    <span class="close" onclick="closeExpenseModal()">&times;</span>
    <h3 id="expenseModalTitle">Add/Edit Transaction</h3>
    <form id="expenseForm">
      <input type="hidden" id="expenseId" />
      <div class="form-group"><label>Reference</label><input type="text" id="expenseRef" required /></div>
      <div class="form-group"><label>Date</label><input type="date" id="expenseDate" /></div>
      <div class="form-group"><label>Type</label><input type="text" id="expenseType" /></div>
      <div class="form-group"><label>Amount</label><input type="number" id="expenseAmount" /></div>
      <div class="form-group"><label>In/Out</label>
        <select id="expenseInOut">
          <option value="Income">Income</option>
          <option value="Expense">Expense</option>
        </select>
      </div>
      <div class="form-group"><label>Description</label><textarea id="expenseDesc"></textarea></div>
      <button type="submit" class="btn btn-primary">Save</button>
    </form>
  </div>
</div>

<!-- User Management View -->
<div id="usersView" class="hidden">
  <h3>User Management</h3>
  <button class="btn btn-success" onclick="openUserModal()">Add User</button>
  <table class="table" id="usersTable">
    <thead>
      <tr>
        <th>Username</th><th>Role</th><th>Status</th><th>Actions</th>
      </tr>
    </thead>
    <tbody>
      <!-- Populated dynamically -->
    </tbody>
  </table>
</div>
<!-- Add/Edit User Modal -->
<div id="userModal" class="modal hidden">
  <div class="modal-content">
    <span class="close" onclick="closeUserModal()">&times;</span>
    <h3 id="userModalTitle">Add/Edit User</h3>
    <form id="userForm">
      <input type="hidden" id="userId" />
      <div class="form-group"><label>Username</label><input type="text" id="userUsername" required /></div>
      <div class="form-group"><label>Password</label><input type="password" id="userPassword" /></div>
      <div class="form-group"><label>Role</label>
        <select id="userRole">
          <option value="Admin">Admin</option>
          <option value="Manager">Manager</option>
          <option value="Logger">Logger</option>
          <option value="Viewer">Viewer</option>
        </select>
      </div>
      <div class="form-group"><label>Status</label>
        <select id="userStatus">
          <option value="Active">Active</option>
          <option value="Inactive">Inactive</option>
        </select>
      </div>
      <button type="submit" class="btn btn-primary">Save</button>
    </form>
  </div>
</div>

<!-- Reports View -->
<div id="reportsView" class="hidden">
  <h3>Reports & Analytics</h3>
  <div>
    <label>Date Range: </label>
    <input type="date" id="reportStart" /> -
    <input type="date" id="reportEnd" />
    <button class="btn btn-primary" onclick="generateReport()">Generate</button>
    <button class="btn btn-secondary" onclick="exportReportExcel()">Export to Excel</button>
  </div>
  <div id="reportResults">
    <!-- Analytics summary and tables dynamically populated -->
  </div>
</div>

<!-- Settings View -->
<div id="settingsView" class="hidden">
  <h3>Settings</h3>
  <form id="settingsForm">
    <div class="form-group"><label>Nursery Name</label><input type="text" id="nurseryName" /></div>
    <div class="form-group"><label>Currency</label>
      <select id="settingsCurrency">
        <option value="KWD">KWD</option>
        <option value="USD">USD</option>
        <option value="SAR">SAR</option>
      </select>
    </div>
    <div class="form-group"><label>Categories (comma-separated)</label>
      <input type="text" id="settingsCategories" placeholder="e.g. Tuition, Transport, Supplies" />
    </div>
    <div class="form-group"><label>Payment Modes (comma-separated)</label>
      <input type="text" id="settingsPaymentModes" placeholder="e.g. Cash, Card, Cheque" />
    </div>
    <button type="submit" class="btn btn-primary">Save Settings</button>
  </form>
</div>
<script>
const APIURL = 'https://YOUR-RENDER-BACKEND-URL/api'; // Change to your actual backend URL

let currentUser = null, students = [], expenses = [], users = [], settings = {};

// Helper for API calls
async function apiCall(query, method = 'POST', data = {}) {
  const response = await fetch(APIURL + query, {
    method,
    headers: { 'Content-Type': 'application/json' },
    body: JSON.stringify(data)
  });
  const res = await response.json();
  if (!res.success) throw new Error(res.message);
  return res;
}

// App initialization
function showView(viewId) {
  ['studentsView','expensesView','usersView','reportsView','settingsView'].forEach(id=>{
    document.getElementById(id).classList.add('hidden');
  });
  document.getElementById(viewId).classList.remove('hidden');
  if(viewId==="studentsView") fetchStudents();
  if(viewId==="expensesView") fetchExpenses();
  if(viewId==="usersView") fetchUsers();
  if(viewId==="settingsView") loadSettings();
}

// Show alerts
function showAlert(containerId, message, type) {
  const el = document.getElementById(containerId);
  if (!el) return;
  el.innerHTML = `<div class="alert alert-${type}">${message}</div>`;
  setTimeout(()=>el.innerHTML='',4000);
}

// ========== LOGIN ==========
document.getElementById('loginForm').onsubmit = async function(e){
  e.preventDefault();
  try {
    const { user } = await apiCall('?collection=users&action=login', 'POST', {
      username: document.getElementById('username').value,
      password: document.getElementById('password').value
    });
    currentUser = user;
    document.getElementById('currentUser').textContent = "Welcome, " + currentUser.username + " (" + currentUser.role + ")";
    document.getElementById('loginScreen').classList.add('hidden');
    document.getElementById('mainDashboard').classList.remove('hidden');
    updateDashboard();
    showView('studentsView');
  } catch (err) {
    showAlert('loginAlert', 'Invalid credentials!', 'error');
  }
}
function logout() {
  currentUser = null;
  document.getElementById('loginScreen').classList.remove('hidden');
  document.getElementById('mainDashboard').classList.add('hidden');
}

// ========== DASHBOARD ==========
async function updateDashboard() {
  await fetchStudents(); await fetchExpenses(); await fetchUsers();
  document.getElementById('totalStudents').textContent = students.length;
  document.getElementById('monthlyIncome').textContent = sumAmount('Income');
  document.getElementById('monthlyExpenses').textContent = sumAmount('Expense');
  document.getElementById('activeUsers').textContent = users.filter(u=>u.status==='Active').length;
}
function sumAmount(type) {
  const today = new Date();
  return expenses.filter(e=>{
    const d = new Date(e.date); 
    return e.inOut===type && d.getMonth()===today.getMonth() && d.getFullYear()===today.getFullYear();
  }).reduce((sum,e)=>sum+Number(e.amount||0),0);
}

// ========== STUDENTS ==========
async function fetchStudents() {
  const res = await apiCall('?collection=students&action=getAll');
  students = res.data;
  populateStudentsTable();
}
function populateStudentsTable() {
  const tbody = document.querySelector("#studentsTable tbody");
  tbody.innerHTML = "";
  students.forEach(st=>{
    tbody.innerHTML += `<tr>
      <td>${st.name}</td><td>${st.guardian}</td><td>${st.mobile}</td>
      <td>${st.class||''}</td><td>${st.joinDate||''}</td><td>${st.status||''}</td>
      <td>
        <button class="btn btn-primary" onclick="openStudentModal('${st._id}')">Edit</button>
        <button class="btn btn-danger" onclick="deleteStudent('${st._id}')">Delete</button>
      </td>
    </tr>`;
  });
}
function openStudentModal(id = "") {
  document.getElementById('studentForm').reset();
  document.getElementById('studentId').value = id;
  if(id) {
    const s = students.find(st=>st._id===id);
    Object.entries(s).forEach(([k,v])=>{
      if(document.getElementById('student'+capitalize(k))) document.getElementById('student'+capitalize(k)).value = v;
    });
  }
  document.getElementById('studentModal').classList.remove('hidden');
}
function closeStudentModal(){ document.getElementById('studentModal').classList.add('hidden'); }
document.getElementById('studentForm').onsubmit = async function(e){
  e.preventDefault();
  const data = {
    name: document.getElementById('studentName').value,
    guardian: document.getElementById('studentGuardian').value,
    mobile: document.getElementById('studentMobile').value,
    class: document.getElementById('studentClass').value,
    joinDate: document.getElementById('studentJoinDate').value,
    status: document.getElementById('studentStatus').value
  };
  try {
    if(document.getElementById('studentId').value)
      await apiCall(`?collection=students&action=update`, 'POST', {id: document.getElementById('studentId').value, ...data});
    else
      await apiCall(`?collection=students&action=create`, 'POST', data);
    fetchStudents();
    closeStudentModal();
  } catch(err){ alert(err.message);}
}
async function deleteStudent(id){
  if(confirm("Delete this student?"))
    { await apiCall(`?collection=students&action=delete`, 'POST', {id}); fetchStudents(); }
}

// ========== EXPENSES/TRANSACTIONS ==========
async function fetchExpenses() {
  const res = await apiCall('?collection=expenses&action=getAll');
  expenses = res.data;
  populateExpensesTable();
}
function populateExpensesTable() {
  const tbody = document.querySelector("#expensesTable tbody");
  tbody.innerHTML = "";
  expenses.forEach(ex=>{
    tbody.innerHTML += `<tr>
      <td>${ex.reference||''}</td><td>${ex.date||''}</td><td>${ex.type||''}</td>
      <td>${ex.amount||''}</td><td>${ex.inOut||''}</td><td>${ex.description||''}</td>
      <td>
        <button class="btn btn-primary" onclick="openExpenseModal('${ex._id}')">Edit</button>
        <button class="btn btn-danger" onclick="deleteExpense('${ex._id}')">Delete</button>
      </td>
    </tr>`;
  });
}
function openExpenseModal(id = "") {
  document.getElementById('expenseForm').reset();
  document.getElementById('expenseId').value = id;
  if(id) {
    const ex = expenses.find(e=>e._id===id);
    Object.entries(ex).forEach(([k,v])=>{
      if(document.getElementById('expense'+capitalize(k))) document.getElementById('expense'+capitalize(k)).value = v;
    });
  }
  document.getElementById('expenseModal').classList.remove('hidden');
}
function closeExpenseModal(){ document.getElementById('expenseModal').classList.add('hidden'); }
document.getElementById('expenseForm').onsubmit = async function(e){
  e.preventDefault();
  const data = {
    reference: document.getElementById('expenseRef').value,
    date: document.getElementById('expenseDate').value,
    type: document.getElementById('expenseType').value,
    amount: document.getElementById('expenseAmount').value,
    inOut: document.getElementById('expenseInOut').value,
    description: document.getElementById('expenseDesc').value
  };
  try {
    if(document.getElementById('expenseId').value)
      await apiCall(`?collection=expenses&action=update`, 'POST', {id: document.getElementById('expenseId').value, ...data});
    else
      await apiCall(`?collection=expenses&action=create`, 'POST', data);
    fetchExpenses();
    closeExpenseModal();
  } catch(err){ alert(err.message);}
}
async function deleteExpense(id){
  if(confirm("Delete this transaction?"))
    { await apiCall(`?collection=expenses&action=delete`, 'POST', {id}); fetchExpenses(); }
}

// ========== USERS ==========
async function fetchUsers() {
  const res = await apiCall('?collection=users&action=getAll');
  users = res.data;
  populateUsersTable();
}
function populateUsersTable() {
  const tbody = document.querySelector("#usersTable tbody");
  tbody.innerHTML = "";
  users.forEach(u=>{
    tbody.innerHTML += `<tr>
      <td>${u.username}</td><td>${u.role}</td><td>${u.status}</td>
      <td>
        <button class="btn btn-primary" onclick="openUserModal('${u._id}')">Edit</button>
        <button class="btn btn-danger" onclick="deleteUser('${u._id}')">Delete</button>
      </td>
    </tr>`;
  });
}
function openUserModal(id = "") {
  document.getElementById('userForm').reset();
  document.getElementById('userId').value = id;
  if(id) {
    const u = users.find(x=>x._id===id);
    document.getElementById('userUsername').value = u.username;
    document.getElementById('userRole').value = u.role;
    document.getElementById('userStatus').value = u.status;
    document.getElementById('userPassword').value = "";
  }
  document.getElementById('userModal').classList.remove('hidden');
}
function closeUserModal(){ document.getElementById('userModal').classList.add('hidden'); }
document.getElementById('userForm').onsubmit = async function(e){
  e.preventDefault();
  const data = {
    username: document.getElementById('userUsername').value,
    role: document.getElementById('userRole').value,
    status: document.getElementById('userStatus').value
  };
  if(document.getElementById('userPassword').value)
    data.password = document.getElementById('userPassword').value;
  try {
    if(document.getElementById('userId').value)
      await apiCall(`?collection=users&action=update`, 'POST', {id: document.getElementById('userId').value, ...data});
    else
      await apiCall(`?collection=users&action=create`, 'POST', data);
    fetchUsers();
    closeUserModal();
  } catch(err){ alert(err.message);}
}
async function deleteUser(id){
  if(confirm("Delete this user?"))
    { await apiCall(`?collection=users&action=delete`, 'POST', {id}); fetchUsers(); }
}

// ========== REPORTS ==========
async function generateReport() {
  // Filter by date range
  const start = document.getElementById('reportStart').value;
  const end = document.getElementById('reportEnd').value;
  const s = start ? new Date(start) : null, e = end ? new Date(end) : null;
  // Filter transactions within range
  const filtered = expenses.filter(tr=>{
    const d=new Date(tr.date);
    return (!s || d>=s) && (!e || d<=e);
  });
  // Prepare summary HTML
  let html = '<h4>Transactions Report</h4>';
  html += `<table class="table"><thead>
    <tr><th>Reference</th><th>Date</th><th>Type</th><th>Amount</th><th>In/Out</th><th>Description</th></tr>
    </thead><tbody>`;
  filtered.forEach(tr=>{
    html += `<tr><td>${tr.reference||''}</td><td>${tr.date||''}</td><td>${tr.type||''}</td><td>${tr.amount||''}</td>
      <td>${tr.inOut||''}</td><td>${tr.description||''}</td></tr>`;
  });
  html += '</tbody></table>';
  document.getElementById('reportResults').innerHTML = html;
}
function exportReportExcel() {
  const table = document.querySelector("#reportResults table");
  if(!table) { alert("No report to export!"); return; }
  const wb = XLSX.utils.table_to_book(table, {sheet:"Report"});
  XLSX.writeFile(wb, "report.xlsx");
}

// ========== SETTINGS ==========
async function loadSettings() {
  const res = await apiCall('?collection=settings&action=getAll');
  settings = res.data[0]||{};
  document.getElementById('nurseryName').value = settings.nurseryName||'';
  document.getElementById('settingsCurrency').value = settings.currency||'KWD';
  document.getElementById('settingsCategories').value = (settings.categories||[]).join(',');
  document.getElementById('settingsPaymentModes').value = (settings.paymentModes||[]).join(',');
}
document.getElementById('settingsForm').onsubmit = async function(e){
  e.preventDefault();
  const data = {
    nurseryName: document.getElementById('nurseryName').value,
    currency: document.getElementById('settingsCurrency').value,
    categories: document.getElementById('settingsCategories').value.split(',').map(x=>x.trim()),
    paymentModes: document.getElementById('settingsPaymentModes').value.split(',').map(x=>x.trim())
  };
  try {
    if (settings._id)
      await apiCall(`?collection=settings&action=update`, 'POST', {id:settings._id, ...data});
    else
      await apiCall(`?collection=settings&action=create`, 'POST', data);
    loadSettings();
    showAlert('settingsAlert','Settings saved!','success');
  } catch(err){ alert(err.message);}
}

// ========== MISC ==========
function capitalize(str){return str.charAt(0).toUpperCase()+str.slice(1);}
document.querySelectorAll('.modal').forEach(m => m.addEventListener('click',e=>{ if(e.target===m) m.classList.add('hidden'); }));

// Set current date/time display
setInterval(() => {
  if(document.getElementById('currentDateTime'))
    document.getElementById('currentDateTime').textContent = new Date().toLocaleString();
}, 1000);

</script>
</body>
</html>
