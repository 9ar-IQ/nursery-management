<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Nursery Management System</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); min-height: 100vh; color: #333; }
        .container { max-width: 1200px; margin: 0 auto; padding: 20px; }
        .login-container { background: white; padding: 40px; border-radius: 15px; box-shadow: 0 15px 35px rgba(0, 0, 0, 0.1); max-width: 400px; margin: 100px auto; }
        .main-dashboard { background: white; border-radius: 15px; box-shadow: 0 15px 35px rgba(0, 0, 0, 0.1); padding: 30px; }
        .loading { text-align: center; padding: 40px; font-size: 18px; color: #667eea; }
        .loading:after { content: '...'; animation: dots 1.5s steps(4, end) infinite; }
        @keyframes dots { 0%, 20% { content: '.'; } 40% { content: '..'; } 60%, 100% { content: '...'; } }
        .header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 30px; padding-bottom: 20px; border-bottom: 2px solid #f0f0f0; }
        .logo { font-size: 28px; font-weight: bold; color: #667eea; }
        .datetime-display { font-size: 14px; color: #666; margin-top: 5px; }
        .nav-menu { display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 20px; margin-bottom: 30px; }
        .nav-button { padding: 20px; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; border: none; border-radius: 10px; cursor: pointer; font-size: 16px; font-weight: 600; transition: all 0.3s ease; }
        .nav-button:hover { transform: translateY(-2px); box-shadow: 0 10px 25px rgba(102, 126, 234, 0.3); }
        .nav-button:disabled { opacity: 0.5; cursor: not-allowed; }
        .btn { padding: 12px 24px; border: none; border-radius: 8px; cursor: pointer; font-size: 14px; font-weight: 600; margin-right: 10px; margin-bottom: 10px; transition: all 0.3s ease; }
        .btn-primary { background: #667eea; color: white; }
        .btn-success { background: #28a745; color: white; }
        .btn-danger { background: #dc3545; color: white; }
        .btn-secondary { background: #6c757d; color: white; }
        .btn:hover { transform: translateY(-1px); box-shadow: 0 5px 15px rgba(0, 0, 0, 0.2); }
        .btn:disabled { opacity: 0.5; cursor: not-allowed; }
        .form-group { margin-bottom: 20px; }
        label { display: block; margin-bottom: 8px; font-weight: 600; color: #555; }
        input, select, textarea { width: 100%; padding: 12px; border: 2px solid #e0e0e0; border-radius: 8px; font-size: 14px; font-family: 'Segoe UI', Arial, sans-serif; }
        input:focus, select:focus, textarea:focus { outline: none; border-color: #667eea; }
        textarea { resize: vertical; }
        .table { width: 100%; border-collapse: collapse; margin-top: 20px; background: white; border-radius: 10px; overflow: hidden; box-shadow: 0 5px 15px rgba(0, 0, 0, 0.1); }
        .table th, .table td { padding: 15px; text-align: left; border-bottom: 1px solid #e0e0e0; }
        .table th { background: #f8f9fa; font-weight: 600; }
        .hidden { display: none !important; }
        .alert { padding: 15px; margin-bottom: 20px; border-radius: 8px; font-weight: 500; }
        .alert-success { background: #d4edda; color: #155724; }
        .alert-error { background: #f8d7da; color: #721c24; }
        .modal { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0, 0, 0, 0.5); display: flex; justify-content: center; align-items: center; z-index: 1000; overflow-y: auto; }
        .modal-content { background: white; padding: 30px; border-radius: 15px; max-width: 700px; width: 90%; max-height: 90vh; overflow-y: auto; margin: 20px; }
        .close-modal { float: right; font-size: 24px; cursor: pointer; color: #999; }
        .quick-stats { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 20px; margin-bottom: 30px; }
        .stat-card { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; padding: 25px; border-radius: 15px; text-align: center; }
        .stat-number { font-size: 32px; font-weight: bold; }
        .form-row { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; }
        .settings-section { background: #f8f9fa; padding: 20px; border-radius: 10px; margin-bottom: 20px; }
        .settings-section h3 { margin-bottom: 15px; color: #555; border-bottom: 1px solid #e0e0e0; padding-bottom: 10px; }
        .permission-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px; margin-top: 10px; }
        .permission-item { padding: 10px; background: white; border-radius: 8px; }
        .permission-item label { margin-bottom: 5px; font-weight: 500; display: flex; align-items: center; }
        .permission-item input[type="checkbox"] { margin-right: 8px; width: auto; }
    </style>
</head>
<body>
    <div id="loginScreen">
        <div class="login-container">
            <h2 style="text-align: center; margin-bottom: 30px; color: #667eea;">Nursery Management System</h2>
            <div id="loginAlert"></div>
            <form id="loginForm">
                <div class="form-group">
                    <label>Username</label>
                    <input type="text" id="username" required>
                </div>
                <div class="form-group">
                    <label>Password</label>
                    <input type="password" id="password" required>
                </div>
                <button type="submit" class="btn btn-primary" style="width: 100%;">Login</button>
                <p style="margin-top: 15px; text-align: center; color: #666; font-size: 12px;">Default: admin / admin123</p>
            </form>
        </div>
    </div>

    <div id="mainDashboard" class="hidden">
        <div class="container">
            <div class="main-dashboard">
                <div class="header">
                    <div>
                        <div class="logo">üè´ Nursery Management</div>
                        <div id="nurseryNameDisplay">My Nursery</div>
                        <div class="datetime-display" id="currentDateTime">Loading...</div>
                    </div>
                    <div>
                        <span id="currentUser">Welcome, Admin</span>
                        <button class="btn btn-secondary" onclick="logout()">Logout</button>
                    </div>
                </div>

                <div id="dashboardView">
                    <div class="quick-stats">
                        <div class="stat-card"><div class="stat-number" id="totalStudents">0</div><div>Total Students</div></div>
                        <div class="stat-card"><div class="stat-number" id="monthlyIncome">$0</div><div>Monthly Income</div></div>
                        <div class="stat-card"><div class="stat-number" id="monthlyExpenses">$0</div><div>Monthly Expenses</div></div>
                        <div class="stat-card"><div class="stat-number" id="activeUsers">0</div><div>Active Users</div></div>
                    </div>
                    <div class="nav-menu">
                        <button class="nav-button" id="navStudents" onclick="showView('studentsView')">üë• Students</button>
                        <button class="nav-button" id="navTransactions" onclick="showView('expensesView')">üí∞ Transactions</button>
                        <button class="nav-button" id="navUsers" onclick="showView('usersView')">üë§ Users</button>
                        <button class="nav-button" id="navReports" onclick="showView('reportsView')">üìä Reports</button>
                        <button class="nav-button" id="navSettings" onclick="showView('settingsView')">‚öôÔ∏è Settings</button>
                    </div>
                </div>

                <div id="studentsView" class="hidden">
                    <div class="header">
                        <h2>Student Management</h2>
                        <div>
                            <button class="btn btn-success" id="btnAddStudent" onclick="showModal('addStudentModal')">Add Student</button>
                            <button class="btn btn-secondary" onclick="showView('dashboardView')">Back</button>
                        </div>
                    </div>
                    <div id="studentsAlert"></div>
                    <table class="table" id="studentsTable">
                        <thead><tr><th>Name</th><th>Guardian</th><th>Mobile</th><th>Class</th><th>Join Date</th><th>Status</th><th>Actions</th></tr></thead>
                        <tbody></tbody>
                    </table>
                </div>

                <div id="expensesView" class="hidden">
                    <div class="header">
                        <h2>Transaction Management</h2>
                        <div>
                            <button class="btn btn-success" id="btnAddTransaction" onclick="showModal('addExpenseModal')">Add Transaction</button>
                            <button class="btn btn-secondary" onclick="showView('dashboardView')">Back</button>
                        </div>
                    </div>
                    <div id="expensesAlert"></div>
                    <table class="table" id="expensesTable">
                        <thead><tr><th>Reference</th><th>Date</th><th>Type</th><th>Amount</th><th>In/Out</th><th>Description</th><th>Actions</th></tr></thead>
                        <tbody></tbody>
                    </table>
                </div>

                <div id="usersView" class="hidden">
                    <div class="header">
                        <h2>User Management</h2>
                        <div>
                            <button class="btn btn-success" id="btnAddUser" onclick="openAddUserModal()">Add User</button>
                            <button class="btn btn-secondary" onclick="showView('dashboardView')">Back</button>
                        </div>
                    </div>
                    <div id="usersAlert"></div>
                    <table class="table" id="usersTable">
                        <thead><tr><th>Username</th><th>Role</th><th>Status</th><th>Actions</th></tr></thead>
                        <tbody></tbody>
                    </table>
                </div>

                <div id="reportsView" class="hidden">
                    <div class="header">
                        <h2>Reports & Analytics</h2>
                        <button class="btn btn-secondary" onclick="showView('dashboardView')">Back</button>
                    </div>
                    <div class="form-row" style="margin-bottom: 20px;">
                        <div class="form-group">
                            <label>From Date:</label>
                            <input type="date" id="reportFromDate">
                        </div>
                        <div class="form-group">
                            <label>To Date:</label>
                            <input type="date" id="reportToDate">
                        </div>
                    </div>
                    <button class="btn btn-primary" onclick="generateReport()">Generate Report</button>
                    <button class="btn btn-success" id="btnExportReport" onclick="exportToExcel()">Export to Excel</button>
                    <div id="reportsAlert"></div>
                    <div id="reportContent"></div>
                </div>

                <div id="settingsView" class="hidden">
                    <div class="header">
                        <h2>System Settings</h2>
                        <button class="btn btn-secondary" onclick="showView('dashboardView')">Back</button>
                    </div>
                    <div id="settingsAlert"></div>
                    
                    <div class="settings-section">
                        <h3>General Settings</h3>
                        <div class="form-row">
                            <div class="form-group">
                                <label>Nursery Name</label>
                                <input type="text" id="nurseryName">
                            </div>
                            <div class="form-group">
                                <label>Currency</label>
                                <input type="text" id="currency" maxlength="3" placeholder="e.g., $, ‚Ç¨, ¬£">
                            </div>
                        </div>
                        <div class="form-row">
                            <div class="form-group">
                                <label>Country/Region</label>
                                <select id="country">
                                    <option value="United States">United States (en-US)</option>
                                    <option value="United Kingdom">United Kingdom (en-GB)</option>
                                    <option value="Kuwait">Kuwait (ar-KW)</option>
                                    <option value="Saudi Arabia">Saudi Arabia (ar-SA)</option>
                                    <option value="UAE">UAE (ar-AE)</option>
                                    <option value="Egypt">Egypt (ar-EG)</option>
                                    <option value="Jordan">Jordan (ar-JO)</option>
                                    <option value="Lebanon">Lebanon (ar-LB)</option>
                                    <option value="France">France (fr-FR)</option>
                                    <option value="Germany">Germany (de-DE)</option>
                                    <option value="Spain">Spain (es-ES)</option>
                                    <option value="Italy">Italy (it-IT)</option>
                                    <option value="India">India (en-IN)</option>
                                    <option value="China">China (zh-CN)</option>
                                    <option value="Japan">Japan (ja-JP)</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label>Timezone</label>
                                <select id="timezone">
                                    <option value="America/New_York">Eastern Time (ET)</option>
                                    <option value="America/Chicago">Central Time (CT)</option>
                                    <option value="America/Denver">Mountain Time (MT)</option>
                                    <option value="America/Los_Angeles">Pacific Time (PT)</option>
                                    <option value="Europe/London">London (GMT)</option>
                                    <option value="Europe/Paris">Paris (CET)</option>
                                    <option value="Asia/Dubai">Dubai (GST)</option>
                                    <option value="Asia/Kuwait">Kuwait</option>
                                    <option value="Asia/Riyadh">Riyadh</option>
                                    <option value="Asia/Amman">Amman</option>
                                    <option value="Asia/Beirut">Beirut</option>
                                    <option value="Asia/Cairo">Cairo</option>
                                    <option value="Asia/Kolkata">India</option>
                                    <option value="Asia/Shanghai">China</option>
                                    <option value="Asia/Tokyo">Tokyo</option>
                                </select>
                            </div>
                        </div>
                        <button class="btn btn-primary" onclick="updateSettings()">Save General Settings</button>
                    </div>

                    <div class="settings-section">
                        <h3>Income Sources</h3>
                        <div class="form-group">
                            <label>Income Sources (one per line)</label>
                            <textarea id="incomeSources" rows="4" placeholder="Student&#10;Bank&#10;Staff Advance&#10;Others"></textarea>
                        </div>
                        <button class="btn btn-primary" onclick="updateIncomeSources()">Save Income Sources</button>
                    </div>

                    <div class="settings-section">
                        <h3>Transaction Categories</h3>
                        <div class="form-row">
                            <div class="form-group">
                                <label>Income Categories</label>
                                <textarea id="incomeCategories" rows="5"></textarea>
                            </div>
                            <div class="form-group">
                                <label>Expense Categories</label>
                                <textarea id="expenseCategories" rows="5"></textarea>
                            </div>
                        </div>
                        <button class="btn btn-primary" onclick="updateCategories()">Save Categories</button>
                    </div>

                    <div class="settings-section">
                        <h3>Payment Methods</h3>
                        <div class="form-row">
                            <div class="form-group">
                                <label>Income Payment Methods</label>
                                <textarea id="incomePaymentMethods" rows="3"></textarea>
                            </div>
                            <div class="form-group">
                                <label>Expense Payment Methods</label>
                                <textarea id="expensePaymentMethods" rows="3"></textarea>
                            </div>
                        </div>
                        <button class="btn btn-primary" onclick="updatePaymentMethods()">Save Payment Methods</button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div id="addStudentModal" class="modal hidden">
        <div class="modal-content">
            <span class="close-modal" onclick="hideModal('addStudentModal')">&times;</span>
            <h3 id="studentModalTitle">Add Student</h3>
            <form id="addStudentForm">
                <input type="hidden" id="editStudentId">
                <div class="form-row">
                    <div class="form-group"><label>First Name *</label><input type="text" name="firstName" required></div>
                    <div class="form-group"><label>Last Name *</label><input type="text" name="lastName" required></div>
                </div>
                <div class="form-row">
                    <div class="form-group"><label>Guardian Name *</label><input type="text" name="guardianName" required></div>
                    <div class="form-group"><label>Guardian Mobile *</label><input type="tel" name="guardianMobile" required></div>
                </div>
                <div class="form-row">
                    <div class="form-group">
                        <label>Class *</label>
                        <select name="class" required>
                            <option value="Nursery 1">Nursery 1</option>
                            <option value="Nursery 2">Nursery 2</option>
                            <option value="KG 1">KG 1</option>
                            <option value="KG 2">KG 2</option>
                        </select>
                    </div>
                    <div class="form-group"><label>Join Date *</label><input type="date" name="joinDate" required></div>
                </div>
                <div class="form-group"><label>Birthday</label><input type="date" name="birthday"></div>
                <div class="form-group"><label>Allergic Notes</label><textarea name="allergicNotes" rows="2"></textarea></div>
                <div class="form-group">
                    <label>Status</label>
                    <select name="status">
                        <option value="Active">Active</option>
                        <option value="On Hold">On Hold</option>
                    </select>
                </div>
                <button type="submit" class="btn btn-success" id="btnSubmitExpense">Add Transaction</button>
                <button type="button" class="btn btn-secondary" onclick="hideModal('addExpenseModal')">Cancel</button>
            </form>
        </div>
    </div>

    <div id="addUserModal" class="modal hidden">
        <div class="modal-content">
            <span class="close-modal" onclick="hideModal('addUserModal')">&times;</span>
            <h3 id="userModalTitle">Add User</h3>
            <form id="addUserForm">
                <input type="hidden" id="editUserId">
                <div class="form-row">
                    <div class="form-group"><label>Username *</label><input type="text" name="username" required></div>
                    <div class="form-group"><label>Password *</label><input type="password" name="password" required></div>
                </div>
                <div class="form-row">
                    <div class="form-group">
                        <label>Role *</label>
                        <select name="role" id="userRoleSelect" required>
                            <option value="Admin">Admin</option>
                            <option value="Manager">Manager</option>
                            <option value="Logger">Logger</option>
                            <option value="Viewer">Viewer</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>Status</label>
                        <select name="status">
                            <option value="Active">Active</option>
                            <option value="On Hold">On Hold</option>
                        </select>
                    </div>
                </div>
                
                <div class="settings-section">
                    <h3>Permissions</h3>
                    <div class="permission-grid">
                        <div class="permission-item">
                            <strong>Students</strong>
                            <label><input type="checkbox" name="perm_students_view"> View</label>
                            <label><input type="checkbox" name="perm_students_add"> Add</label>
                            <label><input type="checkbox" name="perm_students_edit"> Edit</label>
                            <label><input type="checkbox" name="perm_students_delete"> Delete</label>
                        </div>
                        <div class="permission-item">
                            <strong>Transactions</strong>
                            <label><input type="checkbox" name="perm_transactions_view"> View</label>
                            <label><input type="checkbox" name="perm_transactions_add"> Add</label>
                            <label><input type="checkbox" name="perm_transactions_edit"> Edit</label>
                            <label><input type="checkbox" name="perm_transactions_delete"> Delete</label>
                        </div>
                        <div class="permission-item">
                            <strong>Users</strong>
                            <label><input type="checkbox" name="perm_users_view"> View</label>
                            <label><input type="checkbox" name="perm_users_add"> Add</label>
                            <label><input type="checkbox" name="perm_users_edit"> Edit</label>
                            <label><input type="checkbox" name="perm_users_delete"> Delete</label>
                        </div>
                        <div class="permission-item">
                            <strong>Reports</strong>
                            <label><input type="checkbox" name="perm_reports_view"> View</label>
                            <label><input type="checkbox" name="perm_reports_export"> Export</label>
                        </div>
                        <div class="permission-item">
                            <strong>Settings</strong>
                            <label><input type="checkbox" name="perm_settings_view"> View</label>
                            <label><input type="checkbox" name="perm_settings_edit"> Edit</label>
                        </div>
                    </div>
                </div>
                
                <button type="submit" class="btn btn-success" id="btnSubmitUser">Add User</button>
                <button type="button" class="btn btn-secondary" onclick="hideModal('addUserModal')">Cancel</button>
            </form>
        </div>
    </div>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <script>
        const API_URL = '/api';
        let currentUser = null, systemSettings = {}, students = [], expenses = [], users = [];
        let dateTimeInterval = null;

        const ROLE_PRESETS = {
            'Admin': {
                students: { view: true, add: true, edit: true, delete: true },
                transactions: { view: true, add: true, edit: true, delete: true },
                users: { view: true, add: true, edit: true, delete: true },
                reports: { view: true, export: true },
                settings: { view: true, edit: true }
            },
            'Manager': {
                students: { view: true, add: true, edit: true, delete: false },
                transactions: { view: true, add: true, edit: true, delete: false },
                users: { view: true, add: false, edit: false, delete: false },
                reports: { view: true, export: true },
                settings: { view: true, edit: false }
            },
            'Logger': {
                students: { view: true, add: true, edit: true, delete: false },
                transactions: { view: true, add: true, edit: true, delete: false },
                users: { view: false, add: false, edit: false, delete: false },
                reports: { view: true, export: false },
                settings: { view: false, edit: false }
            },
            'Viewer': {
                students: { view: true, add: false, edit: false, delete: false },
                transactions: { view: true, add: false, edit: false, delete: false },
                users: { view: false, add: false, edit: false, delete: false },
                reports: { view: true, export: false },
                settings: { view: false, edit: false }
            }
        };

        async function apiCall(endpoint, options = {}) {
            const response = await fetch(`${API_URL}${endpoint}`, {
                ...options,
                headers: { 'Content-Type': 'application/json', ...options.headers }
            });
            const data = await response.json();
            if (!data.success) throw new Error(data.message || 'API call failed');
            return data;
        }

        function updateDateTime() {
            const timezone = systemSettings.timezone || 'America/New_York';
            const country = systemSettings.country || 'United States';
            
            const localeMap = {
                'Kuwait': 'ar-KW', 'Saudi Arabia': 'ar-SA', 'UAE': 'ar-AE',
                'Egypt': 'ar-EG', 'Jordan': 'ar-JO', 'Lebanon': 'ar-LB',
                'United States': 'en-US', 'United Kingdom': 'en-GB',
                'France': 'fr-FR', 'Germany': 'de-DE', 'Spain': 'es-ES',
                'Italy': 'it-IT', 'India': 'en-IN', 'China': 'zh-CN', 'Japan': 'ja-JP'
            };
            
            const locale = localeMap[country] || 'en-US';
            
            const options = {
                timeZone: timezone,
                weekday: 'long',
                year: 'numeric',
                month: 'long',
                day: 'numeric',
                hour: '2-digit',
                minute: '2-digit',
                second: '2-digit',
                hour12: true
            };
            
            const now = new Date();
            const formatted = now.toLocaleString(locale, options);
            document.getElementById('currentDateTime').textContent = formatted;
        }

        document.addEventListener('DOMContentLoaded', async () => {
            await apiCall('?collection=users&action=initialize', { method: 'POST' }).catch(e => console.log('Init check:', e.message));
            document.getElementById('loginForm').addEventListener('submit', handleLogin);
            document.getElementById('addStudentForm').addEventListener('submit', handleAddStudent);
            document.getElementById('addExpenseForm').addEventListener('submit', handleAddExpense);
            document.getElementById('addUserForm').addEventListener('submit', handleAddUser);
            document.getElementById('inOutSelect').addEventListener('change', handleTransactionTypeChange);
            document.getElementById('userRoleSelect').addEventListener('change', handleRoleChange);
        });

        async function handleLogin(e) {
            e.preventDefault();
            try {
                const result = await apiCall('?collection=auth&action=login', {
                    method: 'POST',
                    body: JSON.stringify({
                        username: document.getElementById('username').value,
                        password: document.getElementById('password').value
                    })
                });
                currentUser = result.user;
                document.getElementById('currentUser').textContent = `Welcome, ${currentUser.username}`;
                document.getElementById('loginScreen').classList.add('hidden');
                document.getElementById('mainDashboard').classList.remove('hidden');
                
                await loadDashboardData();
                applyPermissions();
                
                dateTimeInterval = setInterval(updateDateTime, 1000);
                updateDateTime();
                
                showAlert('loginAlert', 'Login successful!', 'success');
            } catch (error) {
                showAlert('loginAlert', 'Invalid credentials!', 'error');
            }
        }

        function logout() {
            if (dateTimeInterval) clearInterval(dateTimeInterval);
            currentUser = null;
            document.getElementById('loginScreen').classList.remove('hidden');
            document.getElementById('mainDashboard').classList.add('hidden');
            showView('dashboardView');
        }

        function applyPermissions() {
            const perms = currentUser.permissions || {};
            
            // Navigation buttons
            document.getElementById('navStudents').disabled = !perms.students?.view;
            document.getElementById('navTransactions').disabled = !perms.transactions?.view;
            document.getElementById('navUsers').disabled = !perms.users?.view;
            document.getElementById('navReports').disabled = !perms.reports?.view;
            document.getElementById('navSettings').disabled = !perms.settings?.view;
            
            // Action buttons
            if (perms.students) {
                document.getElementById('btnAddStudent').style.display = perms.students.add ? 'inline-block' : 'none';
            }
            if (perms.transactions) {
                document.getElementById('btnAddTransaction').style.display = perms.transactions.add ? 'inline-block' : 'none';
            }
            if (perms.users) {
                document.getElementById('btnAddUser').style.display = perms.users.add ? 'inline-block' : 'none';
            }
            if (perms.reports) {
                document.getElementById('btnExportReport').style.display = perms.reports.export ? 'inline-block' : 'none';
            }
        }

        async function loadDashboardData() {
            const [settingsData, studentsData, expensesData, usersData] = await Promise.all([
                apiCall('?collection=settings&action=get'),
                apiCall('?collection=students&action=getAll'),
                apiCall('?collection=expenses&action=getAll'),
                apiCall('?collection=users&action=getAll')
            ]);
            systemSettings = settingsData.data;
            students = studentsData.data;
            expenses = expensesData.data;
            users = usersData.data;
            updateDashboard();
        }

        function updateDashboard() {
            document.getElementById('nurseryNameDisplay').textContent = systemSettings.nurseryName || 'My Nursery';
            document.getElementById('totalStudents').textContent = students.filter(s => s.status === 'Active').length;
            const month = new Date().getMonth(), year = new Date().getFullYear();
            const income = expenses.filter(e => e.inOut === 'In' && new Date(e.date).getMonth() === month && new Date(e.date).getFullYear() === year).reduce((sum, e) => sum + parseFloat(e.amount), 0);
            const expense = expenses.filter(e => e.inOut === 'Out' && new Date(e.date).getMonth() === month && new Date(e.date).getFullYear() === year).reduce((sum, e) => sum + parseFloat(e.amount), 0);
            document.getElementById('monthlyIncome').textContent = `${systemSettings.currency || ' id="btnSubmitStudent">Add Student</button>
                <button type="button" class="btn btn-secondary" onclick="hideModal('addStudentModal')">Cancel</button>
            </form>
        </div>
    </div>

    <div id="addExpenseModal" class="modal hidden">
        <div class="modal-content">
            <span class="close-modal" onclick="hideModal('addExpenseModal')">&times;</span>
            <h3 id="expenseModalTitle">Add Transaction</h3>
            <form id="addExpenseForm">
                <input type="hidden" id="editExpenseId">
                <div class="form-row">
                    <div class="form-group"><label>Reference</label><input type="text" name="reference" required></div>
                    <div class="form-group"><label>Date *</label><input type="date" name="date" required></div>
                </div>
                <div class="form-row">
                    <div class="form-group">
                        <label>Transaction Type *</label>
                        <select name="inOut" id="inOutSelect" required>
                            <option value="">Select Type</option>
                            <option value="In">Income</option>
                            <option value="Out">Expense</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>Category *</label>
                        <select name="type" id="typeSelect" required>
                            <option value="">Select Category</option>
                        </select>
                    </div>
                </div>
                <div class="form-group" id="incomeSourceGroup" class="hidden">
                    <label>Income Source</label>
                    <select name="incomeSource" id="incomeSourceSelect">
                        <option value="">Select Source</option>
                    </select>
                </div>
                <div class="form-row">
                    <div class="form-group"><label>Amount *</label><input type="number" name="amount" step="0.01" required></div>
                    <div class="form-group">
                        <label>Payment Method *</label>
                        <select name="paymentMethod" id="paymentMethodSelect" required>
                            <option value="">Select Method</option>
                        </select>
                    </div>
                </div>
                <div class="form-group"><label>Description (supports Arabic)</label><textarea name="description" rows="3" placeholder="ŸäŸÖŸÉŸÜŸÉ ÿßŸÑŸÉÿ™ÿßÿ®ÿ© ÿ®ÿßŸÑÿπÿ±ÿ®Ÿäÿ© ŸáŸÜÿß..."></textarea></div>
                <button type="submit" class="btn btn-success"}${income.toFixed(2)}`;
            document.getElementById('monthlyExpenses').textContent = `${systemSettings.currency || ' id="btnSubmitStudent">Add Student</button>
                <button type="button" class="btn btn-secondary" onclick="hideModal('addStudentModal')">Cancel</button>
            </form>
        </div>
    </div>

    <div id="addExpenseModal" class="modal hidden">
        <div class="modal-content">
            <span class="close-modal" onclick="hideModal('addExpenseModal')">&times;</span>
            <h3 id="expenseModalTitle">Add Transaction</h3>
            <form id="addExpenseForm">
                <input type="hidden" id="editExpenseId">
                <div class="form-row">
                    <div class="form-group"><label>Reference</label><input type="text" name="reference" required></div>
                    <div class="form-group"><label>Date *</label><input type="date" name="date" required></div>
                </div>
                <div class="form-row">
                    <div class="form-group">
                        <label>Transaction Type *</label>
                        <select name="inOut" id="inOutSelect" required>
                            <option value="">Select Type</option>
                            <option value="In">Income</option>
                            <option value="Out">Expense</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>Category *</label>
                        <select name="type" id="typeSelect" required>
                            <option value="">Select Category</option>
                        </select>
                    </div>
                </div>
                <div class="form-group" id="incomeSourceGroup" class="hidden">
                    <label>Income Source</label>
                    <select name="incomeSource" id="incomeSourceSelect">
                        <option value="">Select Source</option>
                    </select>
                </div>
                <div class="form-row">
                    <div class="form-group"><label>Amount *</label><input type="number" name="amount" step="0.01" required></div>
                    <div class="form-group">
                        <label>Payment Method *</label>
                        <select name="paymentMethod" id="paymentMethodSelect" required>
                            <option value="">Select Method</option>
                        </select>
                    </div>
                </div>
                <div class="form-group"><label>Description (supports Arabic)</label><textarea name="description" rows="3" placeholder="ŸäŸÖŸÉŸÜŸÉ ÿßŸÑŸÉÿ™ÿßÿ®ÿ© ÿ®ÿßŸÑÿπÿ±ÿ®Ÿäÿ© ŸáŸÜÿß..."></textarea></div>
                <button type="submit" class="btn btn-success"}${expense.toFixed(2)}`;
            document.getElementById('activeUsers').textContent = users.filter(u => u.status === 'Active').length;
        }

        function showView(viewId) {
            ['dashboardView', 'studentsView', 'expensesView', 'usersView', 'reportsView', 'settingsView'].forEach(v => document.getElementById(v).classList.add('hidden'));
            document.getElementById(viewId).classList.remove('hidden');
            if (viewId === 'studentsView') loadStudentsTable();
            if (viewId === 'expensesView') loadExpensesTable();
            if (viewId === 'usersView') loadUsersTable();
            if (viewId === 'settingsView') loadSettingsForm();
        }

        function showModal(modalId) { 
            document.getElementById(modalId).classList.remove('hidden'); 
            if (modalId === 'addExpenseModal') {
                document.getElementById('editExpenseId').value = '';
                document.getElementById('expenseModalTitle').textContent = 'Add Transaction';
                document.getElementById('btnSubmitExpense').textContent = 'Add Transaction';
                document.querySelector('#addExpenseForm input[name="date"]').value = new Date().toISOString().split('T')[0];
                document.querySelector('#addExpenseForm input[name="reference"]').value = 'AUTO';
            }
            if (modalId === 'addStudentModal') {
                document.getElementById('editStudentId').value = '';
                document.getElementById('studentModalTitle').textContent = 'Add Student';
                document.getElementById('btnSubmitStudent').textContent = 'Add Student';
                document.querySelector('#addStudentForm input[name="joinDate"]').value = new Date().toISOString().split('T')[0];
            }
        }
        
        function hideModal(modalId) { 
            document.getElementById(modalId).classList.add('hidden'); 
            document.getElementById(modalId).querySelector('form').reset(); 
        }
        
        function showAlert(containerId, message, type) {
            const container = document.getElementById(containerId);
            container.innerHTML = `<div class="alert alert-${type}">${message}</div>`;
            setTimeout(() => container.innerHTML = '', 5000);
        }

        function handleTransactionTypeChange() {
            const inOut = document.getElementById('inOutSelect').value;
            const typeSelect = document.getElementById('typeSelect');
            const paymentMethodSelect = document.getElementById('paymentMethodSelect');
            const incomeSourceGroup = document.getElementById('incomeSourceGroup');
            const incomeSourceSelect = document.getElementById('incomeSourceSelect');
            
            typeSelect.innerHTML = '<option value="">Select Category</option>';
            paymentMethodSelect.innerHTML = '<option value="">Select Method</option>';
            
            if (inOut === 'In') {
                (systemSettings.incomeCategories || []).forEach(cat => {
                    typeSelect.innerHTML += `<option value="${cat}">${cat}</option>`;
                });
                (systemSettings.incomePaymentMethods || []).forEach(pm => {
                    paymentMethodSelect.innerHTML += `<option value="${pm}">${pm}</option>`;
                });
                incomeSourceGroup.classList.remove('hidden');
                incomeSourceSelect.innerHTML = '<option value="">Select Source</option>';
                (systemSettings.incomeSources || ['Student', 'Bank', 'Staff Advance', 'Others']).forEach(src => {
                    incomeSourceSelect.innerHTML += `<option value="${src}">${src}</option>`;
                });
            } else if (inOut === 'Out') {
                (systemSettings.expenseCategories || []).forEach(cat => {
                    typeSelect.innerHTML += `<option value="${cat}">${cat}</option>`;
                });
                (systemSettings.expensePaymentMethods || []).forEach(pm => {
                    paymentMethodSelect.innerHTML += `<option value="${pm}">${pm}</option>`;
                });
                incomeSourceGroup.classList.add('hidden');
            }
        }

        function handleRoleChange() {
            const role = document.getElementById('userRoleSelect').value;
            const preset = ROLE_PRESETS[role];
            if (preset) {
                Object.keys(preset).forEach(module => {
                    Object.keys(preset[module]).forEach(action => {
                        const checkbox = document.querySelector(`input[name="perm_${module}_${action}"]`);
                        if (checkbox) checkbox.checked = preset[module][action];
                    });
                });
            }
        }

        async function loadStudentsTable() {
            const tbody = document.querySelector('#studentsTable tbody');
            tbody.innerHTML = '';
            const perms = currentUser.permissions?.students || {};
            
            students.forEach(s => {
                const row = tbody.insertRow();
                let actions = '';
                if (perms.edit) actions += `<button class="btn btn-primary" onclick="editStudent('${s._id}')">Edit</button>`;
                if (perms.delete) actions += `<button class="btn btn-danger" onclick="deleteStudent('${s._id}')">Delete</button>`;
                
                row.innerHTML = `
                    <td>${s.firstName} ${s.lastName}</td>
                    <td>${s.guardianName || 'N/A'}</td>
                    <td>${s.guardianMobile || 'N/A'}</td>
                    <td>${s.class}</td>
                    <td>${s.joinDate}</td>
                    <td>${s.status}</td>
                    <td>${actions || 'No actions'}</td>
                `;
            });
        }

        async function loadExpensesTable() {
            const tbody = document.querySelector('#expensesTable tbody');
            tbody.innerHTML = '';
            const perms = currentUser.permissions?.transactions || {};
            
            expenses.forEach(e => {
                const row = tbody.insertRow();
                let actions = '';
                if (perms.edit) actions += `<button class="btn btn-primary" onclick="editExpense('${e._id}')">Edit</button>`;
                if (perms.delete) actions += `<button class="btn btn-danger" onclick="deleteExpense('${e._id}')">Delete</button>`;
                
                row.innerHTML = `
                    <td>${e.reference}</td>
                    <td>${e.date}</td>
                    <td>${e.type}</td>
                    <td>${systemSettings.currency || ' id="btnSubmitStudent">Add Student</button>
                <button type="button" class="btn btn-secondary" onclick="hideModal('addStudentModal')">Cancel</button>
            </form>
        </div>
    </div>

    <div id="addExpenseModal" class="modal hidden">
        <div class="modal-content">
            <span class="close-modal" onclick="hideModal('addExpenseModal')">&times;</span>
            <h3 id="expenseModalTitle">Add Transaction</h3>
            <form id="addExpenseForm">
                <input type="hidden" id="editExpenseId">
                <div class="form-row">
                    <div class="form-group"><label>Reference</label><input type="text" name="reference" required></div>
                    <div class="form-group"><label>Date *</label><input type="date" name="date" required></div>
                </div>
                <div class="form-row">
                    <div class="form-group">
                        <label>Transaction Type *</label>
                        <select name="inOut" id="inOutSelect" required>
                            <option value="">Select Type</option>
                            <option value="In">Income</option>
                            <option value="Out">Expense</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>Category *</label>
                        <select name="type" id="typeSelect" required>
                            <option value="">Select Category</option>
                        </select>
                    </div>
                </div>
                <div class="form-group" id="incomeSourceGroup" class="hidden">
                    <label>Income Source</label>
                    <select name="incomeSource" id="incomeSourceSelect">
                        <option value="">Select Source</option>
                    </select>
                </div>
                <div class="form-row">
                    <div class="form-group"><label>Amount *</label><input type="number" name="amount" step="0.01" required></div>
                    <div class="form-group">
                        <label>Payment Method *</label>
                        <select name="paymentMethod" id="paymentMethodSelect" required>
                            <option value="">Select Method</option>
                        </select>
                    </div>
                </div>
                <div class="form-group"><label>Description (supports Arabic)</label><textarea name="description" rows="3" placeholder="ŸäŸÖŸÉŸÜŸÉ ÿßŸÑŸÉÿ™ÿßÿ®ÿ© ÿ®ÿßŸÑÿπÿ±ÿ®Ÿäÿ© ŸáŸÜÿß..."></textarea></div>
                <button type="submit" class="btn btn-success"}${parseFloat(e.amount).toFixed(2)}</td>
                    <td style="color: ${e.inOut === 'In' ? 'green' : 'red'}">${e.inOut === 'In' ? 'Income' : 'Expense'}</td>
                    <td>${e.description || '-'}</td>
                    <td>${actions || 'No actions'}</td>
                `;
            });
        }

        async function loadUsersTable() {
            const tbody = document.querySelector('#usersTable tbody');
            tbody.innerHTML = '';
            const perms = currentUser.permissions?.users || {};
            
            users.forEach(u => {
                const row = tbody.insertRow();
                let actions = '';
                if (perms.edit) actions += `<button class="btn btn-primary" onclick="editUser('${u._id}')">Edit</button>`;
                if (perms.delete && u.username !== 'admin') actions += `<button class="btn btn-danger" onclick="deleteUser('${u._id}')">Delete</button>`;
                
                row.innerHTML = `
                    <td>${u.username}</td>
                    <td>${u.role}</td>
                    <td>${u.status}</td>
                    <td>${actions || 'No actions'}</td>
                `;
            });
        }

        function loadSettingsForm() {
            document.getElementById('nurseryName').value = systemSettings.nurseryName || '';
            document.getElementById('currency').value = systemSettings.currency || ' id="btnSubmitStudent">Add Student</button>
                <button type="button" class="btn btn-secondary" onclick="hideModal('addStudentModal')">Cancel</button>
            </form>
        </div>
    </div>

    <div id="addExpenseModal" class="modal hidden">
        <div class="modal-content">
            <span class="close-modal" onclick="hideModal('addExpenseModal')">&times;</span>
            <h3 id="expenseModalTitle">Add Transaction</h3>
            <form id="addExpenseForm">
                <input type="hidden" id="editExpenseId">
                <div class="form-row">
                    <div class="form-group"><label>Reference</label><input type="text" name="reference" required></div>
                    <div class="form-group"><label>Date *</label><input type="date" name="date" required></div>
                </div>
                <div class="form-row">
                    <div class="form-group">
                        <label>Transaction Type *</label>
                        <select name="inOut" id="inOutSelect" required>
                            <option value="">Select Type</option>
                            <option value="In">Income</option>
                            <option value="Out">Expense</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>Category *</label>
                        <select name="type" id="typeSelect" required>
                            <option value="">Select Category</option>
                        </select>
                    </div>
                </div>
                <div class="form-group" id="incomeSourceGroup" class="hidden">
                    <label>Income Source</label>
                    <select name="incomeSource" id="incomeSourceSelect">
                        <option value="">Select Source</option>
                    </select>
                </div>
                <div class="form-row">
                    <div class="form-group"><label>Amount *</label><input type="number" name="amount" step="0.01" required></div>
                    <div class="form-group">
                        <label>Payment Method *</label>
                        <select name="paymentMethod" id="paymentMethodSelect" required>
                            <option value="">Select Method</option>
                        </select>
                    </div>
                </div>
                <div class="form-group"><label>Description (supports Arabic)</label><textarea name="description" rows="3" placeholder="ŸäŸÖŸÉŸÜŸÉ ÿßŸÑŸÉÿ™ÿßÿ®ÿ© ÿ®ÿßŸÑÿπÿ±ÿ®Ÿäÿ© ŸáŸÜÿß..."></textarea></div>
                <button type="submit" class="btn btn-success";
            document.getElementById('country').value = systemSettings.country || 'United States';
            document.getElementById('timezone').value = systemSettings.timezone || 'America/New_York';
            document.getElementById('incomeSources').value = (systemSettings.incomeSources || []).join('\n');
            document.getElementById('incomeCategories').value = (systemSettings.incomeCategories || []).join('\n');
            document.getElementById('expenseCategories').value = (systemSettings.expenseCategories || []).join('\n');
            document.getElementById('incomePaymentMethods').value = (systemSettings.incomePaymentMethods || []).join('\n');
            document.getElementById('expensePaymentMethods').value = (systemSettings.expensePaymentMethods || []).join('\n');
        }

        async function handleAddStudent(e) {
            e.preventDefault();
            const formData = new FormData(e.target);
            const editId = document.getElementById('editStudentId').value;
            
            const data = {
                firstName: formData.get('firstName'),
                lastName: formData.get('lastName'),
                guardianName: formData.get('guardianName'),
                guardianMobile: formData.get('guardianMobile'),
                class: formData.get('class'),
                joinDate: formData.get('joinDate'),
                birthday: formData.get('birthday'),
                allergicNotes: formData.get('allergicNotes'),
                status: formData.get('status')
            };
            
            if (editId) {
                await apiCall(`?collection=students&action=update&id=${editId}`, { method: 'PUT', body: JSON.stringify(data) });
                showAlert('studentsAlert', 'Student updated successfully!', 'success');
            } else {
                await apiCall('?collection=students&action=create', { method: 'POST', body: JSON.stringify(data) });
                showAlert('studentsAlert', 'Student added successfully!', 'success');
            }
            
            await loadDashboardData();
            loadStudentsTable();
            hideModal('addStudentModal');
        }

        async function editStudent(id) {
            const student = students.find(s => s._id === id);
            if (!student) return;
            
            document.getElementById('editStudentId').value = id;
            document.getElementById('studentModalTitle').textContent = 'Edit Student';
            document.getElementById('btnSubmitStudent').textContent = 'Update Student';
            
            const form = document.getElementById('addStudentForm');
            form.elements.firstName.value = student.firstName;
            form.elements.lastName.value = student.lastName;
            form.elements.guardianName.value = student.guardianName || '';
            form.elements.guardianMobile.value = student.guardianMobile || '';
            form.elements.class.value = student.class;
            form.elements.joinDate.value = student.joinDate;
            form.elements.birthday.value = student.birthday || '';
            form.elements.allergicNotes.value = student.allergicNotes || '';
            form.elements.status.value = student.status;
            
            showModal('addStudentModal');
        }

        async function handleAddExpense(e) {
            e.preventDefault();
            const formData = new FormData(e.target);
            const editId = document.getElementById('editExpenseId').value;
            
            const data = {
                reference: formData.get('reference'),
                date: formData.get('date'),
                type: formData.get('type'),
                amount: formData.get('amount'),
                paymentMethod: formData.get('paymentMethod'),
                inOut: formData.get('inOut'),
                incomeSource: formData.get('incomeSource'),
                description: formData.get('description')
            };
            
            if (editId) {
                await apiCall(`?collection=expenses&action=update&id=${editId}`, { method: 'PUT', body: JSON.stringify(data) });
                showAlert('expensesAlert', 'Transaction updated successfully!', 'success');
            } else {
                await apiCall('?collection=expenses&action=create', { method: 'POST', body: JSON.stringify(data) });
                showAlert('expensesAlert', 'Transaction added successfully!', 'success');
            }
            
            await loadDashboardData();
            loadExpensesTable();
            hideModal('addExpenseModal');
        }

        async function editExpense(id) {
            const expense = expenses.find(e => e._id === id);
            if (!expense) return;
            
            document.getElementById('editExpenseId').value = id;
            document.getElementById('expenseModalTitle').textContent = 'Edit Transaction';
            document.getElementById('btnSubmitExpense').textContent = 'Update Transaction';
            
            const form = document.getElementById('addExpenseForm');
            form.elements.reference.value = expense.reference;
            form.elements.date.value = expense.date;
            form.elements.inOut.value = expense.inOut;
            handleTransactionTypeChange();
            form.elements.type.value = expense.type;
            form.elements.amount.value = expense.amount;
            form.elements.paymentMethod.value = expense.paymentMethod;
            form.elements.incomeSource.value = expense.incomeSource || '';
            form.elements.description.value = expense.description || '';
            
            showModal('addExpenseModal');
        }

        async function handleAddUser(e) {
            e.preventDefault();
            const formData = new FormData(e.target);
            const editId = document.getElementById('editUserId').value;
            
            const permissions = {
                students: {
                    view: formData.get('perm_students_view') === 'on',
                    add: formData.get('perm_students_add') === 'on',
                    edit: formData.get('perm_students_edit') === 'on',
                    delete: formData.get('perm_students_delete') === 'on'
                },
                transactions: {
                    view: formData.get('perm_transactions_view') === 'on',
                    add: formData.get('perm_transactions_add') === 'on',
                    edit: formData.get('perm_transactions_edit') === 'on',
                    delete: formData.get('perm_transactions_delete') === 'on'
                },
                users: {
                    view: formData.get('perm_users_view') === 'on',
                    add: formData.get('perm_users_add') === 'on',
                    edit: formData.get('perm_users_edit') === 'on',
                    delete: formData.get('perm_users_delete') === 'on'
                },
                reports: {
                    view: formData.get('perm_reports_view') === 'on',
                    export: formData.get('perm_reports_export') === 'on'
                },
                settings: {
                    view: formData.get('perm_settings_view') === 'on',
                    edit: formData.get('perm_settings_edit') === 'on'
                }
            };
            
            const data = {
                username: formData.get('username'),
                password: formData.get('password'),
                role: formData.get('role'),
                status: formData.get('status'),
                permissions: permissions,
                createdDate: new Date().toISOString().split('T')[0]
            };
            
            if (editId) {
                await apiCall(`?collection=users&action=update&id=${editId}`, { method: 'PUT', body: JSON.stringify(data) });
                showAlert('usersAlert', 'User updated successfully!', 'success');
            } else {
                await apiCall('?collection=users&action=create', { method: 'POST', body: JSON.stringify(data) });
                showAlert('usersAlert', 'User added successfully!', 'success');
            }
            
            await loadDashboardData();
            loadUsersTable();
            hideModal('addUserModal');
        }

        function openAddUserModal() {
            document.getElementById('editUserId').value = '';
            document.getElementById('userModalTitle').textContent = 'Add User';
            document.getElementById('btnSubmitUser').textContent = 'Add User';
            document.getElementById('addUserForm').reset();
            showModal('addUserModal');
        }

        async function editUser(id) {
            const user = users.find(u => u._id === id);
            if (!user) return;
            
            document.getElementById('editUserId').value = id;
            document.getElementById('userModalTitle').textContent = 'Edit User';
            document.getElementById('btnSubmitUser').textContent = 'Update User';
            
            const form = document.getElementById('addUserForm');
            form.elements.username.value = user.username;
            form.elements.password.value = user.password;
            form.elements.role.value = user.role;
            form.elements.status.value = user.status;
            
            if (user.permissions) {
                Object.keys(user.permissions).forEach(module => {
                    Object.keys(user.permissions[module]).forEach(action => {
                        const checkbox = form.querySelector(`input[name="perm_${module}_${action}"]`);
                        if (checkbox) checkbox.checked = user.permissions[module][action];
                    });
                });
            }
            
            showModal('addUserModal');
        }

        async function deleteStudent(id) {
            if (!confirm('Delete this student?')) return;
            await apiCall(`?collection=students&action=delete&id=${id}`, { method: 'DELETE' });
            await loadDashboardData();
            loadStudentsTable();
            showAlert('studentsAlert', 'Student deleted!', 'success');
        }

        async function deleteExpense(id) {
            if (!confirm('Delete this transaction?')) return;
            await apiCall(`?collection=expenses&action=delete&id=${id}`, { method: 'DELETE' });
            await loadDashboardData();
            loadExpensesTable();
            showAlert('expensesAlert', 'Transaction deleted!', 'success');
        }

        async function deleteUser(id) {
            if (!confirm('Delete this user?')) return;
            await apiCall(`?collection=users&action=delete&id=${id}`, { method: 'DELETE' });
            await loadDashboardData();
            loadUsersTable();
            showAlert('usersAlert', 'User deleted!', 'success');
        }

        async function updateSettings() {
            const data = {
                nurseryName: document.getElementById('nurseryName').value,
                currency: document.getElementById('currency').value,
                country: document.getElementById('country').value,
                timezone: document.getElementById('timezone').value
            };
            await apiCall('?collection=settings&action=update', { method: 'POST', body: JSON.stringify(data) });
            await loadDashboardData();
            updateDateTime();
            showAlert('settingsAlert', 'Settings updated!', 'success');
        }

        async function updateIncomeSources() {
            const incomeSources = document.getElementById('incomeSources').value.split('\n').filter(s => s.trim() !== '');
            await apiCall('?collection=settings&action=update', { method: 'POST', body: JSON.stringify({ incomeSources }) });
            await loadDashboardData();
            showAlert('settingsAlert', 'Income sources updated!', 'success');
        }

        async function updateCategories() {
            const incomeCategories = document.getElementById('incomeCategories').value.split('\n').filter(c => c.trim() !== '');
            const expenseCategories = document.getElementById('expenseCategories').value.split('\n').filter(c => c.trim() !== '');
            await apiCall('?collection=settings&action=update', { method: 'POST', body: JSON.stringify({ incomeCategories, expenseCategories }) });
            await loadDashboardData();
            showAlert('settingsAlert', 'Categories updated!', 'success');
        }

        async function updatePaymentMethods() {
            const incomePaymentMethods = document.getElementById('incomePaymentMethods').value.split('\n').filter(m => m.trim() !== '');
            const expensePaymentMethods = document.getElementById('expensePaymentMethods').value.split('\n').filter(m => m.trim() !== '');
            await apiCall('?collection=settings&action=update', { method: 'POST', body: JSON.stringify({ incomePaymentMethods, expensePaymentMethods }) });
            await loadDashboardData();
            showAlert('settingsAlert', 'Payment methods updated!', 'success');
        }

        function generateReport() {
            const fromDate = document.getElementById('reportFromDate').value;
            const toDate = document.getElementById('reportToDate').value;
            
            if (!fromDate || !toDate) {
                showAlert('reportsAlert', 'Please select both dates!', 'error');
                return;
            }
            
            const filtered = expenses.filter(e => e.date >= fromDate && e.date <= toDate);
            const income = filtered.filter(e => e.inOut === 'In').reduce((sum, e) => sum + parseFloat(e.amount), 0);
            const expense = filtered.filter(e => e.inOut === 'Out').reduce((sum, e) => sum + parseFloat(e.amount), 0);
            
            document.getElementById('reportContent').innerHTML = `
                <div style="background: #f8f9fa; padding: 20px; border-radius: 10px; margin-top: 20px;">
                    <h3>Financial Report (${fromDate} to ${toDate})</h3>
                    <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 20px; margin-top: 20px;">
                        <div style="text-align: center;">
                            <h4 style="color: green;">Total Income</h4>
                            <p style="font-size: 24px; font-weight: bold;">${systemSettings.currency}${income.toFixed(2)}</p>
                        </div>
                        <div style="text-align: center;">
                            <h4 style="color: red;">Total Expenses</h4>
                            <p style="font-size: 24px; font-weight: bold;">${systemSettings.currency}${expense.toFixed(2)}</p>
                        </div>
                        <div style="text-align: center;">
                            <h4 style="color: ${income - expense >= 0 ? 'green' : 'red'};">Net Profit</h4>
                            <p style="font-size: 24px; font-weight: bold;">${systemSettings.currency}${(income - expense).toFixed(2)}</p>
                        </div>
                    </div>
                </div>
                <table class="table" style="margin-top: 20px;">
                    <thead>
                        <tr><th>Reference</th><th>Date</th><th>Type</th><th>Amount</th><th>In/Out</th><th>Description</th></tr>
                    </thead>
                    <tbody>
                        ${filtered.map(e => `
                            <tr>
                                <td>${e.reference}</td>
                                <td>${e.date}</td>
                                <td>${e.type}</td>
                                <td>${systemSettings.currency}${parseFloat(e.amount).toFixed(2)}</td>
                                <td style="color: ${e.inOut === 'In' ? 'green' : 'red'}">${e.inOut === 'In' ? 'Income' : 'Expense'}</td>
                                <td>${e.description || '-'}</td>
                            </tr>
                        `).join('')}
                    </tbody>
                </table>
            `;
        }

        function exportToExcel() {
            const fromDate = document.getElementById('reportFromDate').value;
            const toDate = document.getElementById('reportToDate').value;
            
            if (!fromDate || !toDate) {
                showAlert('reportsAlert', 'Please generate a report first!', 'error');
                return;
            }
            
            const filtered = expenses.filter(e => e.date >= fromDate && e.date <= toDate);
            
            // Prepare data with Arabic support
            const data = filtered.map(e => ({
                'Reference': e.reference,
                'Date': e.date,
                'Type': e.type,
                'Amount': parseFloat(e.amount).toFixed(2),
                'In/Out': e.inOut === 'In' ? 'Income' : 'Expense',
                'Payment Method': e.paymentMethod,
                'Income Source': e.incomeSource || '-',
                'Description': e.description || '-'
            }));
            
            // Create worksheet with UTF-8 support
            const ws = XLSX.utils.json_to_sheet(data);
            
            // Set column widths
            ws['!cols'] = [
                {wch: 15}, // Reference
                {wch: 12}, // Date
                {wch: 20}, // Type
                {wch: 12}, // Amount
                {wch: 10}, // In/Out
                {wch: 15}, // Payment Method
                {wch: 15}, // Income Source
                {wch: 40}  // Description (wider for Arabic text)
            ];
            
            // Create workbook
            const wb = XLSX.utils.book_new();
            XLSX.utils.book_append_sheet(wb, ws, 'Transactions');
            
            // Add summary sheet
            const income = filtered.filter(e => e.inOut === 'In').reduce((sum, e) => sum + parseFloat(e.amount), 0);
            const expense = filtered.filter(e => e.inOut === 'Out').reduce((sum, e) => sum + parseFloat(e.amount), 0);
            
            const summary = [
                ['Financial Summary', ''],
                ['Period', `${fromDate} to ${toDate}`],
                ['Total Income', income.toFixed(2)],
                ['Total Expenses', expense.toFixed(2)],
                ['Net Profit', (income - expense).toFixed(2)]
            ];
            
            const ws_summary = XLSX.utils.aoa_to_sheet(summary);
            XLSX.utils.book_append_sheet(wb, ws_summary, 'Summary');
            
            // Export with UTF-8 encoding for Arabic support
            XLSX.writeFile(wb, `Nursery_Report_${fromDate}_to_${toDate}.xlsx`, { 
                bookType: 'xlsx',
                type: 'binary',
                codepage: 65001 // UTF-8 encoding
            });
            
            showAlert('reportsAlert', 'Report exported successfully!', 'success');
        }
    </script>
</body>
</html> id="btnSubmitStudent">Add Student</button>
                <button type="button" class="btn btn-secondary" onclick="hideModal('addStudentModal')">Cancel</button>
            </form>
        </div>
    </div>

    <div id="addExpenseModal" class="modal hidden">
        <div class="modal-content">
            <span class="close-modal" onclick="hideModal('addExpenseModal')">&times;</span>
            <h3 id="expenseModalTitle">Add Transaction</h3>
            <form id="addExpenseForm">
                <input type="hidden" id="editExpenseId">
                <div class="form-row">
                    <div class="form-group"><label>Reference</label><input type="text" name="reference" required></div>
                    <div class="form-group"><label>Date *</label><input type="date" name="date" required></div>
                </div>
                <div class="form-row">
                    <div class="form-group">
                        <label>Transaction Type *</label>
                        <select name="inOut" id="inOutSelect" required>
                            <option value="">Select Type</option>
                            <option value="In">Income</option>
                            <option value="Out">Expense</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>Category *</label>
                        <select name="type" id="typeSelect" required>
                            <option value="">Select Category</option>
                        </select>
                    </div>
                </div>
                <div class="form-group" id="incomeSourceGroup" class="hidden">
                    <label>Income Source</label>
                    <select name="incomeSource" id="incomeSourceSelect">
                        <option value="">Select Source</option>
                    </select>
                </div>
                <div class="form-row">
                    <div class="form-group"><label>Amount *</label><input type="number" name="amount" step="0.01" required></div>
                    <div class="form-group">
                        <label>Payment Method *</label>
                        <select name="paymentMethod" id="paymentMethodSelect" required>
                            <option value="">Select Method</option>
                        </select>
                    </div>
                </div>
                <div class="form-group"><label>Description (supports Arabic)</label><textarea name="description" rows="3" placeholder="ŸäŸÖŸÉŸÜŸÉ ÿßŸÑŸÉÿ™ÿßÿ®ÿ© ÿ®ÿßŸÑÿπÿ±ÿ®Ÿäÿ© ŸáŸÜÿß..."></textarea></div>
                <button type="submit" class="btn btn-success"
