<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Nursery Management System</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); min-height: 100vh; color: #333; }
        .container { max-width: 1200px; margin: 0 auto; padding: 20px; }
        .login-container { background: white; padding: 40px; border-radius: 15px; box-shadow: 0 15px 35px rgba(0, 0, 0, 0.1); max-width: 400px; margin: 100px auto; }
        .main-dashboard { background: white; border-radius: 15px; box-shadow: 0 15px 35px rgba(0, 0, 0, 0.1); padding: 30px; }
        .header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 30px; padding-bottom: 20px; border-bottom: 2px solid #f0f0f0; }
        .logo { font-size: 28px; font-weight: bold; color: #667eea; }
        .datetime-display { font-size: 14px; color: #666; margin-top: 5px; }
        .nav-menu { display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 20px; margin-bottom: 30px; }
        .nav-button { padding: 20px; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; border: none; border-radius: 10px; cursor: pointer; font-size: 16px; font-weight: 600; transition: all 0.3s ease; }
        .nav-button:hover { transform: translateY(-2px); box-shadow: 0 10px 25px rgba(102, 126, 234, 0.3); }
        .nav-button:disabled { opacity: 0.5; cursor: not-allowed; }
        .btn { padding: 12px 24px; border: none; border-radius: 8px; cursor: pointer; font-size: 14px; font-weight: 600; margin-right: 10px; margin-bottom: 10px; transition: all 0.3s ease; }
        .btn-primary { background: #667eea; color: white; }
        .btn-success { background: #28a745; color: white; }
        .btn-danger { background: #dc3545; color: white; }
        .btn-secondary { background: #6c757d; color: white; }
        .btn:hover { transform: translateY(-1px); box-shadow: 0 5px 15px rgba(0, 0, 0, 0.2); }
        .btn:disabled { opacity: 0.5; cursor: not-allowed; }
        .form-group { margin-bottom: 20px; }
        label { display: block; margin-bottom: 8px; font-weight: 600; color: #555; }
        input, select, textarea { width: 100%; padding: 12px; border: 2px solid #e0e0e0; border-radius: 8px; font-size: 14px; font-family: inherit; }
        input:focus, select:focus, textarea:focus { outline: none; border-color: #667eea; }
        textarea { resize: vertical; }
        .table { width: 100%; border-collapse: collapse; margin-top: 20px; background: white; border-radius: 10px; overflow: hidden; box-shadow: 0 5px 15px rgba(0, 0, 0, 0.1); }
        .table th, .table td { padding: 15px; text-align: left; border-bottom: 1px solid #e0e0e0; }
        .table th { background: #f8f9fa; font-weight: 600; }
        .hidden { display: none !important; }
        .alert { padding: 15px; margin-bottom: 20px; border-radius: 8px; font-weight: 500; }
        .alert-success { background: #d4edda; color: #155724; }
        .alert-error { background: #f8d7da; color: #721c24; }
        .modal { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0, 0, 0, 0.5); display: flex; justify-content: center; align-items: center; z-index: 1000; overflow-y: auto; }
        .modal-content { background: white; padding: 30px; border-radius: 15px; max-width: 700px; width: 90%; max-height: 90vh; overflow-y: auto; margin: 20px; }
        .close-modal { float: right; font-size: 24px; cursor: pointer; color: #999; }
        .quick-stats { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 20px; margin-bottom: 30px; }
        .stat-card { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; padding: 25px; border-radius: 15px; text-align: center; }
        .stat-number { font-size: 32px; font-weight: bold; }
        .form-row { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; }
        .settings-section { background: #f8f9fa; padding: 20px; border-radius: 10px; margin-bottom: 20px; }
        .settings-section h3 { margin-bottom: 15px; color: #555; border-bottom: 1px solid #e0e0e0; padding-bottom: 10px; }
        .permission-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px; margin-top: 10px; }
        .permission-item { padding: 10px; background: white; border-radius: 8px; }
        .permission-item label { margin-bottom: 5px; font-weight: 500; display: flex; align-items: center; }
        .permission-item input[type="checkbox"] { margin-right: 8px; width: auto; }
    </style>
</head>
<body>
    <div id="loginScreen">
        <div class="login-container">
            <h2 style="text-align: center; margin-bottom: 30px; color: #667eea;">Nursery Management System</h2>
            <div id="loginAlert"></div>
            <form id="loginForm">
                <div class="form-group">
                    <label>Username</label>
                    <input type="text" id="loginUsername" required>
                </div>
                <div class="form-group">
                    <label>Password</label>
                    <input type="password" id="loginPassword" required>
                </div>
                <button type="submit" class="btn btn-primary" style="width: 100%;">Login</button>
            </form>
        </div>
    </div>

    <div id="mainDashboard" class="hidden">
        <div class="container">
            <div class="main-dashboard">
                <div class="header">
                    <div>
                        <div class="logo">Nursery Management</div>
                        <div id="nurseryNameDisplay">My Nursery</div>
                        <div class="datetime-display" id="currentDateTime">Loading...</div>
                    </div>
                    <div>
                        <span id="currentUser">Welcome</span>
                        <button class="btn btn-secondary" onclick="logout()">Logout</button>
                    </div>
                </div>

                <div id="dashboardView">
                    <div class="quick-stats">
                        <div class="stat-card"><div class="stat-number" id="totalStudents">0</div><div>Total Students</div></div>
                        <div class="stat-card"><div class="stat-number" id="monthlyIncome">$0</div><div>Monthly Income</div></div>
                        <div class="stat-card"><div class="stat-number" id="monthlyExpenses">$0</div><div>Monthly Expenses</div></div>
                        <div class="stat-card"><div class="stat-number" id="activeUsers">0</div><div>Active Users</div></div>
                    </div>
                    <div class="nav-menu">
                        <button class="nav-button" id="navStudents" onclick="showView('studentsView')">Students</button>
                        <button class="nav-button" id="navTransactions" onclick="showView('expensesView')">Transactions</button>
                        <button class="nav-button" id="navUsers" onclick="showView('usersView')">Users</button>
                        <button class="nav-button" id="navReports" onclick="showView('reportsView')">Reports</button>
                        <button class="nav-button" id="navSettings" onclick="showView('settingsView')">Settings</button>
                    </div>
                </div>

                <div id="studentsView" class="hidden">
                    <div class="header">
                        <h2>Student Management</h2>
                        <div>
                            <button class="btn btn-success" id="btnAddStudent" onclick="showModal('addStudentModal')">Add Student</button>
                            <button class="btn btn-secondary" onclick="showView('dashboardView')">Back</button>
                        </div>
                    </div>
                    <div id="studentsAlert"></div>
                    <table class="table" id="studentsTable">
                        <thead><tr><th>Name</th><th>Guardian</th><th>Mobile</th><th>Class</th><th>Join Date</th><th>Status</th><th>Actions</th></tr></thead>
                        <tbody></tbody>
                    </table>
                </div>

                <div id="expensesView" class="hidden">
                    <div class="header">
                        <h2>Transaction Management</h2>
                        <div>
                            <button class="btn btn-success" id="btnAddTransaction" onclick="showModal('addExpenseModal')">Add Transaction</button>
                            <button class="btn btn-secondary" onclick="showView('dashboardView')">Back</button>
                        </div>
                    </div>
                    <div id="expensesAlert"></div>
                    <table class="table" id="expensesTable">
                        <thead><tr><th>Reference</th><th>Date</th><th>Type</th><th>Amount</th><th>In/Out</th><th>Description</th><th>Actions</th></tr></thead>
                        <tbody></tbody>
                    </table>
                </div>

                <div id="usersView" class="hidden">
                    <div class="header">
                        <h2>User Management</h2>
                        <div>
                            <button class="btn btn-success" id="btnAddUser" onclick="openAddUserModal()">Add User</button>
                            <button class="btn btn-secondary" onclick="showView('dashboardView')">Back</button>
                        </div>
                    </div>
                    <div id="usersAlert"></div>
                    <table class="table" id="usersTable">
                        <thead><tr><th>Username</th><th>Role</th><th>Status</th><th>Actions</th></tr></thead>
                        <tbody></tbody>
                    </table>
                </div>

                <div id="reportsView" class="hidden">
                    <div class="header">
                        <h2>Reports</h2>
                        <button class="btn btn-secondary" onclick="showView('dashboardView')">Back</button>
                    </div>
                    <div class="form-row" style="margin-bottom: 20px;">
                        <div class="form-group">
                            <label>From Date:</label>
                            <input type="date" id="reportFromDate">
                        </div>
                        <div class="form-group">
                            <label>To Date:</label>
                            <input type="date" id="reportToDate">
                        </div>
                    </div>
                    <button class="btn btn-primary" onclick="generateReport()">Generate Report</button>
                    <button class="btn btn-success" id="btnExportReport" onclick="exportToExcel()">Export to Excel</button>
                    <div id="reportsAlert"></div>
                    <div id="reportContent"></div>
                </div>

                <div id="settingsView" class="hidden">
                    <div class="header">
                        <h2>System Settings</h2>
                        <button class="btn btn-secondary" onclick="showView('dashboardView')">Back</button>
                    </div>
                    <div id="settingsAlert"></div>
                    
                    <div class="settings-section">
                        <h3>General Settings</h3>
                        <div class="form-row">
                            <div class="form-group">
                                <label>Nursery Name</label>
                                <input type="text" id="nurseryName">
                            </div>
                            <div class="form-group">
                                <label>Currency</label>
                                <input type="text" id="currency" maxlength="3">
                            </div>
                        </div>
                        <div class="form-row">
                            <div class="form-group">
                                <label>Country</label>
                                <select id="country">
                                    <option value="United States">United States</option>
                                    <option value="Kuwait">Kuwait</option>
                                    <option value="Saudi Arabia">Saudi Arabia</option>
                                    <option value="UAE">UAE</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label>Timezone</label>
                                <select id="timezone">
                                    <option value="America/New_York">Eastern Time</option>
                                    <option value="Asia/Kuwait">Kuwait</option>
                                    <option value="Asia/Riyadh">Riyadh</option>
                                    <option value="Asia/Dubai">Dubai</option>
                                </select>
                            </div>
                        </div>
                        <button class="btn btn-primary" onclick="updateSettings()">Save Settings</button>
                    </div>

                    <div class="settings-section">
                        <h3>Income Sources</h3>
                        <div class="form-group">
                            <label>Income Sources (one per line)</label>
                            <textarea id="incomeSources" rows="4"></textarea>
                        </div>
                        <button class="btn btn-primary" onclick="updateIncomeSources()">Save</button>
                    </div>

                    <div class="settings-section">
                        <h3>Transaction Categories</h3>
                        <div class="form-row">
                            <div class="form-group">
                                <label>Income Categories</label>
                                <textarea id="incomeCategories" rows="5"></textarea>
                            </div>
                            <div class="form-group">
                                <label>Expense Categories</label>
                                <textarea id="expenseCategories" rows="5"></textarea>
                            </div>
                        </div>
                        <button class="btn btn-primary" onclick="updateCategories()">Save</button>
                    </div>

                    <div class="settings-section">
                        <h3>Payment Methods</h3>
                        <div class="form-row">
                            <div class="form-group">
                                <label>Income Payment Methods</label>
                                <textarea id="incomePaymentMethods" rows="3"></textarea>
                            </div>
                            <div class="form-group">
                                <label>Expense Payment Methods</label>
                                <textarea id="expensePaymentMethods" rows="3"></textarea>
                            </div>
                        </div>
                        <button class="btn btn-primary" onclick="updatePaymentMethods()">Save</button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div id="addStudentModal" class="modal hidden">
        <div class="modal-content">
            <span class="close-modal" onclick="hideModal('addStudentModal')">&times;</span>
            <h3 id="studentModalTitle">Add Student</h3>
            <form id="addStudentForm">
                <input type="hidden" id="editStudentId">
                <div class="form-row">
                    <div class="form-group"><label>First Name</label><input type="text" name="firstName" required></div>
                    <div class="form-group"><label>Last Name</label><input type="text" name="lastName" required></div>
                </div>
                <div class="form-row">
                    <div class="form-group"><label>Guardian Name</label><input type="text" name="guardianName" required></div>
                    <div class="form-group"><label>Guardian Mobile</label><input type="tel" name="guardianMobile" required></div>
                </div>
                <div class="form-row">
                    <div class="form-group">
                        <label>Class</label>
                        <select name="class" required>
                            <option value="Nursery 1">Nursery 1</option>
                            <option value="Nursery 2">Nursery 2</option>
                            <option value="KG 1">KG 1</option>
                            <option value="KG 2">KG 2</option>
                        </select>
                    </div>
                    <div class="form-group"><label>Join Date</label><input type="date" name="joinDate" required></div>
                </div>
                <div class="form-group"><label>Birthday</label><input type="date" name="birthday"></div>
                <div class="form-group"><label>Allergic Notes</label><textarea name="allergicNotes" rows="2"></textarea></div>
                <div class="form-group">
                    <label>Status</label>
                    <select name="status">
                        <option value="Active">Active</option>
                        <option value="On Hold">On Hold</option>
                    </select>
                </div>
                <button type="submit" class="btn btn-success">Add Student</button>
                <button type="button" class="btn btn-secondary" onclick="hideModal('addStudentModal')">Cancel</button>
            </form>
        </div>
    </div>

    <div id="addExpenseModal" class="modal hidden">
        <div class="modal-content">
            <span class="close-modal" onclick="hideModal('addExpenseModal')">&times;</span>
            <h3>Add Transaction</h3>
            <form id="addExpenseForm">
                <input type="hidden" id="editExpenseId">
                <div class="form-row">
                    <div class="form-group"><label>Reference</label><input type="text" name="reference" required></div>
                    <div class="form-group"><label>Date</label><input type="date" name="date" required></div>
                </div>
                <div class="form-row">
                    <div class="form-group">
                        <label>Transaction Type</label>
                        <select name="inOut" id="inOutSelect" required>
                            <option value="">Select Type</option>
                            <option value="In">Income</option>
                            <option value="Out">Expense</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>Category</label>
                        <select name="type" id="typeSelect" required>
                            <option value="">Select Category</option>
                        </select>
                    </div>
                </div>
                <div class="form-group hidden" id="incomeSourceGroup">
                    <label>Income Source</label>
                    <select name="incomeSource" id="incomeSourceSelect">
                        <option value="">Select Source</option>
                    </select>
                </div>
                <div class="form-row">
                    <div class="form-group"><label>Amount</label><input type="number" name="amount" step="0.01" required></div>
                    <div class="form-group">
                        <label>Payment Method</label>
                        <select name="paymentMethod" id="paymentMethodSelect" required>
                            <option value="">Select Method</option>
                        </select>
                    </div>
                </div>
                <div class="form-group"><label>Description</label><textarea name="description" rows="3"></textarea></div>
                <button type="submit" class="btn btn-success">Add Transaction</button>
                <button type="button" class="btn btn-secondary" onclick="hideModal('addExpenseModal')">Cancel</button>
            </form>
        </div>
    </div>

    <div id="addUserModal" class="modal hidden">
        <div class="modal-content">
            <span class="close-modal" onclick="hideModal('addUserModal')">&times;</span>
            <h3>Add User</h3>
            <form id="addUserForm">
                <input type="hidden" id="editUserId">
                <div class="form-row">
                    <div class="form-group"><label>Username</label><input type="text" name="username" required></div>
                    <div class="form-group"><label>Password</label><input type="password" name="password" required></div>
                </div>
                <div class="form-row">
                    <div class="form-group">
                        <label>Role</label>
                        <select name="role" id="userRoleSelect" required>
                            <option value="Admin">Admin</option>
                            <option value="Manager">Manager</option>
                            <option value="Logger">Logger</option>
                            <option value="Viewer">Viewer</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>Status</label>
                        <select name="status">
                            <option value="Active">Active</option>
                            <option value="On Hold">On Hold</option>
                        </select>
                    </div>
                </div>
                
                <div class="settings-section">
                    <h3>Permissions</h3>
                    <div class="permission-grid">
                        <div class="permission-item">
                            <strong>Students</strong>
                            <label><input type="checkbox" name="perm_students_view"> View</label>
                            <label><input type="checkbox" name="perm_students_add"> Add</label>
                            <label><input type="checkbox" name="perm_students_edit"> Edit</label>
                            <label><input type="checkbox" name="perm_students_delete"> Delete</label>
                        </div>
                        <div class="permission-item">
                            <strong>Transactions</strong>
                            <label><input type="checkbox" name="perm_transactions_view"> View</label>
                            <label><input type="checkbox" name="perm_transactions_add"> Add</label>
                            <label><input type="checkbox" name="perm_transactions_edit"> Edit</label>
                            <label><input type="checkbox" name="perm_transactions_delete"> Delete</label>
                        </div>
                        <div class="permission-item">
                            <strong>Users</strong>
                            <label><input type="checkbox" name="perm_users_view"> View</label>
                            <label><input type="checkbox" name="perm_users_add"> Add</label>
                            <label><input type="checkbox" name="perm_users_edit"> Edit</label>
                            <label><input type="checkbox" name="perm_users_delete"> Delete</label>
                        </div>
                        <div class="permission-item">
                            <strong>Reports</strong>
                            <label><input type="checkbox" name="perm_reports_view"> View</label>
                            <label><input type="checkbox" name="perm_reports_export"> Export</label>
                        </div>
                        <div class="permission-item">
                            <strong>Settings</strong>
                            <label><input type="checkbox" name="perm_settings_view"> View</label>
                            <label><input type="checkbox" name="perm_settings_edit"> Edit</label>
                        </div>
                    </div>
                </div>
                
                <button type="submit" class="btn btn-success">Add User</button>
                <button type="button" class="btn btn-secondary" onclick="hideModal('addUserModal')">Cancel</button>
            </form>
        </div>
    </div>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <script>
const API_URL='/api';let currentUser=null,systemSettings={},students=[],expenses=[],users=[],dateTimeInterval=null;const ROLE_PRESETS={Admin:{students:{view:!0,add:!0,edit:!0,delete:!0},transactions:{view:!0,add:!0,edit:!0,delete:!0},users:{view:!0,add:!0,edit:!0,delete:!0},reports:{view:!0,export:!0},settings:{view:!0,edit:!0}},Manager:{students:{view:!0,add:!0,edit:!0,delete:!1},transactions:{view:!0,add:!0,edit:!0,delete:!1},users:{view:!0,add:!1,edit:!1,delete:!1},reports:{view:!0,export:!0},settings:{view:!0,edit:!1}},Logger:{students:{view:!0,add:!0,edit:!0,delete:!1},transactions:{view:!0,add:!0,edit:!0,delete:!1},users:{view:!1,add:!1,edit:!1,delete:!1},reports:{view:!0,export:!1},settings:{view:!1,edit:!1}},Viewer:{students:{view:!0,add:!1,edit:!1,delete:!1},transactions:{view:!0,add:!1,edit:!1,delete:!1},users:{view:!1,add:!1,edit:!1,delete:!1},reports:{view:!0,export:!1},settings:{view:!1,edit:!1}}};async function apiCall(e,t={}){const s=await fetch(`${API_URL}${e}`,{...t,headers:{"Content-Type":"application/json",...t.headers}}),a=await s.json();if(!a.success)throw new Error(a.message||"API call failed");return a}function updateDateTime(){const e=systemSettings.timezone||"America/New_York",t=systemSettings.country||"United States",s={Kuwait:"ar-KW","Saudi Arabia":"ar-SA",UAE:"ar-AE",Egypt:"ar-EG",Jordan:"ar-JO",Lebanon:"ar-LB","United States":"en-US","United Kingdom":"en-GB",France:"fr-FR",Germany:"de-DE",Spain:"es-ES",Italy:"it-IT",India:"en-IN",China:"zh-CN",Japan:"ja-JP"}[t]||"en-US",a={timeZone:e,weekday:"long",year:"numeric",month:"long",day:"numeric",hour:"2-digit",minute:"2-digit",second:"2-digit",hour12:!0};document.getElementById("currentDateTime").textContent=(new Date).toLocaleString(s,a)}document.addEventListener("DOMContentLoaded",function(){apiCall("?collection=users&action=initialize",{method:"POST"}).catch(e=>console.log("Init:",e.message)),document.getElementById("loginForm").addEventListener("submit",handleLogin),document.getElementById("addStudentForm").addEventListener("submit",handleAddStudent),document.getElementById("addExpenseForm").addEventListener("submit",handleAddExpense),document.getElementById("addUserForm").addEventListener("submit",handleAddUser),document.getElementById("inOutSelect").addEventListener("change",handleTransactionTypeChange),document.getElementById("userRoleSelect").addEventListener("change",handleRoleChange)});async function handleLogin(e){e.preventDefault();try{const e=await apiCall("?collection=auth&action=login",{method:"POST",body:JSON.stringify({username:document.getElementById("loginUsername").value,password:document.getElementById("loginPassword").value})});currentUser=e.user,document.getElementById("currentUser").textContent=`Welcome, ${currentUser.username}`,document.getElementById("loginScreen").classList.add("hidden"),document.getElementById("mainDashboard").classList.remove("hidden"),await loadDashboardData(),applyPermissions(),dateTimeInterval=setInterval(updateDateTime,1e3),updateDateTime()}catch(e){showAlert("loginAlert",`Login failed: ${e.message}`,"error")}}function logout(){dateTimeInterval&&clearInterval(dateTimeInterval),currentUser=null,document.getElementById("loginScreen").classList.remove("hidden"),document.getElementById("mainDashboard").classList.add("hidden"),document.getElementById("loginForm").reset(),showView("dashboardView")}function applyPermissions(){const e=currentUser.permissions||{};document.getElementById("navStudents").disabled=!e.students?.view,document.getElementById("navTransactions").disabled=!e.transactions?.view,document.getElementById("navUsers").disabled=!e.users?.view,document.getElementById("navReports").disabled=!e.reports?.view,document.getElementById("navSettings").disabled=!e.settings?.view,e.students&&(document.getElementById("btnAddStudent").style.display=e.students.add?"inline-block":"none"),e.transactions&&(document.getElementById("btnAddTransaction").style.display=e.transactions.add?"inline-block":"none"),e.users&&(document.getElementById("btnAddUser").style.display=e.users.add?"inline-block":"none"),e.reports&&(document.getElementById("btnExportReport").style.display=e.reports.export?"inline-block":"none")}async function loadDashboardData(){const[e,t,s,a]=await Promise.all([apiCall("?collection=settings&action=get"),apiCall("?collection=students&action=getAll"),apiCall("?collection=expenses&action=getAll"),apiCall("?collection=users&action=getAll")]);systemSettings=e.data,students=t.data,expenses=s.data,users=a.data,updateDashboard()}function updateDashboard(){document.getElementById("nurseryNameDisplay").textContent=systemSettings.nurseryName||"My Nursery",document.getElementById("totalStudents").textContent=students.filter(e=>"Active"===e.status).length;const e=(new Date).getMonth(),t=(new Date).getFullYear(),s=expenses.filter(s=>"In"===s.inOut&&(new Date(s.date)).getMonth()===e&&(new Date(s.date)).getFullYear()===t).reduce((e,t)=>e+parseFloat(t.amount),0),a=expenses.filter(s=>"Out"===s.inOut&&(new Date(s.date)).getMonth()===e&&(new Date(s.date)).getFullYear()===t).reduce((e,t)=>e+parseFloat(t.amount),0);document.getElementById("monthlyIncome").textContent=`${systemSettings.currency||"$"}${s.toFixed(2)}`,document.getElementById("monthlyExpenses").textContent=`${systemSettings.currency||"$"}${a.toFixed(2)}`,document.getElementById("activeUsers").textContent=users.filter(e=>"Active"===e.status).length}function showView(e){["dashboardView","studentsView","expensesView","usersView","reportsView","settingsView"].forEach(e=>document.getElementById(e).classList.add("hidden")),document.getElementById(e).classList.remove("hidden"),"studentsView"===e&&loadStudentsTable(),"expensesView"===e&&loadExpensesTable(),"usersView"===e&&loadUsersTable(),"settingsView"===e&&loadSettingsForm()}function showModal(e){document.getElementById(e).classList.remove("hidden"),"addExpenseModal"===e&&(document.getElementById("editExpenseId").value="",document.querySelector("#addExpenseForm input[name=date]").value=(new Date).toISOString().split("T")[0],document.querySelector("#addExpenseForm input[name=reference]").value="AUTO"),"addStudentModal"===e&&(document.getElementById("editStudentId").value="",document.querySelector("#addStudentForm input[name=joinDate]").value=(new Date).toISOString().split("T")[0])}function hideModal(e){document.getElementById(e).classList.add("hidden"),document.getElementById(e).querySelector("form").reset()}function showAlert(e,t,s){const a=document.getElementById(e);a.innerHTML=`<div class="alert alert-${s}">${t}</div>`,setTimeout(()=>a.innerHTML="",5e3)}function handleTransactionTypeChange(){const e=document.getElementById("inOutSelect").value,t=document.getElementById("typeSelect"),s=document.getElementById("paymentMethodSelect"),a=document.getElementById("incomeSourceGroup"),n=document.getElementById("incomeSourceSelect");if(t.innerHTML='<option value="">Select Category</option>',s.innerHTML='<option value="">Select Method</option>',"In"===e){(systemSettings.incomeCategories||[]).forEach(e=>{t.innerHTML+=`<option value="${e}">${e}</option>`}),(systemSettings.incomePaymentMethods||[]).forEach(e=>{s.innerHTML+=`<option value="${e}">${e}</option>`}),a.classList.remove("hidden"),n.innerHTML='<option value="">Select Source</option>',(systemSettings.incomeSources||["Student","Bank","Staff Advance","Others"]).forEach(e=>{n.innerHTML+=`<option value="${e}">${e}</option>`})}else"Out"===e&&((systemSettings.expenseCategories||[]).forEach(e=>{t.innerHTML+=`<option value="${e}">${e}</option>`}),(systemSettings.expensePaymentMethods||[]).forEach(e=>{s.innerHTML+=`<option value="${e}">${e}</option>`}),a.classList.add("hidden"))}function handleRoleChange(){const e=document.getElementById("userRoleSelect").value,t=ROLE_PRESETS[e];t&&Object.keys(t).forEach(e=>{Object.keys(t[e]).forEach(s=>{const a=document.querySelector(`input[name="perm_${e}_${s}"]`);a&&(a.checked=t[e][s])})})}async function loadStudentsTable(){const e=document.querySelector("#studentsTable tbody");e.innerHTML="";const t=currentUser.permissions?.students||{};students.forEach(s=>{const a=e.insertRow();let n="";t.edit&&(n+=`<button class="btn btn-primary" onclick="editStudent('${s._id}')">Edit</button>`),t.delete&&(n+=`<button class="btn btn-danger" onclick="deleteStudent('${s._id}')">Delete</button>`),a.innerHTML=`<td>${s.firstName} ${s.lastName}</td><td>${s.guardianName||"N/A"}</td><td>${s.guardianMobile||"N/A"}</td><td>${s.class}</td><td>${s.joinDate}</td><td>${s.status}</td><td>${n||"No actions"}</td>`})}async function loadExpensesTable(){const e=document.querySelector("#expensesTable tbody");e.innerHTML="";const t=currentUser.permissions?.transactions||{};expenses.forEach(s=>{const a=e.insertRow();let n="";t.edit&&(n+=`<button class="btn btn-primary" onclick="editExpense('${s._id}')">Edit</button>`),t.delete&&(n+=`<button class="btn btn-danger" onclick="deleteExpense('${s._id}')">Delete</button>`),a.innerHTML=`<td>${s.reference}</td><td>${s.date}</td><td>${s.type}</td><td>${systemSettings.currency||"$"}${parseFloat(s.amount).toFixed(2)}</td><td style="color:${s.inOut==="In"?"green":"red"}">${s.inOut==="In"?"Income":"Expense"}</td><td>${s.description||"-"}</td><td>${n||"No actions"}</td>`})}async function loadUsersTable(){const e=document.querySelector("#usersTable tbody");e.innerHTML="";const t=currentUser.permissions?.users||{};users.forEach(s=>{const a=e.insertRow();let n="";t.edit&&(n+=`<button class="btn btn-primary" onclick="editUser('${s._id}')">Edit</button>`),t.delete&&"admin"!==s.username&&(n+=`<button class="btn btn-danger" onclick="deleteUser('${s._id}')">Delete</button>`),a.innerHTML=`<td>${s.username}</td><td>${s.role}</td><td>${s.status}</td><td>${n||"No actions"}</td>`})}function loadSettingsForm(){document.getElementById("nurseryName").value=systemSettings.nurseryName||"",document.getElementById("currency").value=systemSettings.currency||"$",document.getElementById("country").value=systemSettings.country||"United States",document.getElementById("timezone").value=systemSettings.timezone||"America/New_York",document.getElementById("incomeSources").value=(systemSettings.incomeSources||[]).join("\n"),document.getElementById("incomeCategories").value=(systemSettings.incomeCategories||[]).join("\n"),document.getElementById("expenseCategories").value=(systemSettings.expenseCategories||[]).join("\n"),document.getElementById("incomePaymentMethods").value=(systemSettings.incomePaymentMethods||[]).join("\n"),document.getElementById("expensePaymentMethods").value=(systemSettings.expensePaymentMethods||[]).join("\n")}async function handleAddStudent(e){e.preventDefault();const t=new FormData(e.target),s=document.getElementById("editStudentId").value,a={firstName:t.get("firstName"),lastName:t.get("lastName"),guardianName:t.get("guardianName"),guardianMobile:t.get("guardianMobile"),class:t.get("class"),joinDate:t.get("joinDate"),birthday:t.get("birthday"),allergicNotes:t.get("allergicNotes"),status:t.get("status")};s?(await apiCall(`?collection=students&action=update&id=${s}`,{method:"PUT",body:JSON.stringify(a)}),showAlert("studentsAlert","Student updated!","success")):(await apiCall("?collection=students&action=create",{method:"POST",body:JSON.stringify(a)}),showAlert("studentsAlert","Student added!","success")),await loadDashboardData(),loadStudentsTable(),hideModal("addStudentModal")}async function editStudent(e){const t=students.find(t=>t._id===e);if(!t)return;document.getElementById("editStudentId").value=e;const s=document.getElementById("addStudentForm");s.elements.firstName.value=t.firstName,s.elements.lastName.value=t.lastName,s.elements.guardianName.value=t.guardianName||"",s.elements.guardianMobile.value=t.guardianMobile||"",s.elements.class.value=t.class,s.elements.joinDate.value=t.joinDate,s.elements.birthday.value=t.birthday||"",s.elements.allergicNotes.value=t.allergicNotes||"",s.elements.status.value=t.status,showModal("addStudentModal")}async function handleAddExpense(e){e.preventDefault();const t=new FormData(e.target),s=document.getElementById("editExpenseId").value,a={reference:t.get("reference"),date:t.get("date"),type:t.get("type"),amount:t.get("amount"),paymentMethod:t.get("paymentMethod"),inOut:t.get("inOut"),incomeSource:t.get("incomeSource"),description:t.get("description")};s?(await apiCall(`?collection=expenses&action=update&id=${s}`,{method:"PUT",body:JSON.stringify(a)}),showAlert("expensesAlert","Transaction updated!","success")):(await apiCall("?collection=expenses&action=create",{method:"POST",body:JSON.stringify(a)}),showAlert("expensesAlert","Transaction added!","success")),await loadDashboardData(),loadExpensesTable(),hideModal("addExpenseModal")}async function editExpense(e){const t=expenses.find(t=>t._id===e);if(!t)return;document.getElementById("editExpenseId").value=e;const s=document.getElementById("addExpenseForm");s.elements.reference.value=t.reference,s.elements.date.value=t.date,s.elements.inOut.value=t.inOut,handleTransactionTypeChange(),s.elements.type.value=t.type,s.elements.amount.value=t.amount,s.elements.paymentMethod.value=t.paymentMethod,s.elements.incomeSource.value=t.incomeSource||"",s.elements.description.value=t.description||"",showModal("addExpenseModal")}async function handleAddUser(e){e.preventDefault();const t=new FormData(e.target),s=document.getElementById("editUserId").value,a={students:{view:"on"===t.get("perm_students_view"),add:"on"===t.get("perm_students_add"),edit:"on"===t.get("perm_students_edit"),delete:"on"===t.get("perm_students_delete")},transactions:{view:"on"===t.get("perm_transactions_view"),add:"on"===t.get("perm_transactions_add"),edit:"on"===t.get("perm_transactions_edit"),delete:"on"===t.get("perm_transactions_delete")},users:{view:"on"===t.get("perm_users_view"),add:"on"===t.get("perm_users_add"),edit:"on"===t.get("perm_users_edit"),delete:"on"===t.get("perm_users_delete")},reports:{view:"on"===t.get("perm_reports_view"),export:"on"===t.get("perm_reports_export")},settings:{view:"on"===t.get("perm_settings_view"),edit:"on"===t.get("perm_settings_edit")}},n={username:t.get("username"),password:t.get("password"),role:t.get("role"),status:t.get("status"),permissions:a,createdDate:(new Date).toISOString().split("T")[0]};s?(await apiCall(`?collection=users&action=update&id=${s}`,{method:"PUT",body:JSON.stringify(n)}),showAlert("usersAlert","User updated!","success")):(await apiCall("?collection=users&action=create",{method:"POST",body:JSON.stringify(n)}),showAlert("usersAlert","User added!","success")),await loadDashboardData(),loadUsersTable(),hideModal("addUserModal")}function openAddUserModal(){document.getElementById("editUserId").value="",document.getElementById("addUserForm").reset(),showModal("addUserModal")}async function editUser(e){const t=users.find(t=>t._id===e);if(!t)return;document.getElementById("editUserId").value=e;const s=document.getElementById("addUserForm");if(s.elements.username.value=t.username,s.elements.password.value=t.password,s.elements.role.value=t.role,s.elements.status.value=t.status,t.permissions){Object.keys(t.permissions).forEach(e=>{Object.keys(t.permissions[e]).forEach(a=>{const n=s.querySelector(`input[name="perm_${e}_${a}"]`);n&&(n.checked=t.permissions[e][a])})})}showModal("addUserModal")}async function deleteStudent(e){confirm("Delete this student?")&&(await apiCall(`?collection=students&action=delete&id=${e}`,{method:"DELETE"}),await loadDashboardData(),loadStudentsTable(),showAlert("studentsAlert","Student deleted!","success"))}async function deleteExpense(e){confirm("Delete this transaction?")&&(await apiCall(`?collection=expenses&action=delete&id=${e}`,{method:"DELETE"}),await loadDashboardData(),loadExpensesTable(),showAlert("expensesAlert","Transaction deleted!","success"))}async function deleteUser(e){confirm("Delete this user?")&&(await apiCall(`?collection=users&action=delete&id=${e}`,{method:"DELETE"}),await loadDashboardData(),loadUsersTable(),showAlert("usersAlert","User deleted!","success"))}async function updateSettings(){const e={nurseryName:document.getElementById("nurseryName").value,currency:document.getElementById("currency").value,country:document.getElementById("country").value,timezone:document.getElementById("timezone").value};await apiCall("?collection=settings&action=update",{method:"POST",body:JSON.stringify(e)}),await loadDashboardData(),updateDateTime(),showAlert("settingsAlert","Settings updated!","success")}async function updateIncomeSources(){const e=document.getElementById("incomeSources").value.split("\n").filter(e=>""!==e.trim());await apiCall("?collection=settings&action=update",{method:"POST",body:JSON.stringify({incomeSources:e})}),await loadDashboardData(),showAlert("settingsAlert","Income sources updated!","success")}async function updateCategories(){const e=document.getElementById("incomeCategories").value.split("\n").filter(e=>""!==e.trim()),t=document.getElementById("expenseCategories").value.split("\n").filter(e=>""!==e.trim());await apiCall("?collection=settings&action=update",{method:"POST",body:JSON.stringify({incomeCategories:e,expenseCategories:t})}),await loadDashboardData(),showAlert("settingsAlert","Categories updated!","success")}async function updatePaymentMethods(){const e=document.getElementById("incomePaymentMethods").value.split("\n").filter(e=>""!==e.trim()),t=document.getElementById("expensePaymentMethods").value.split("\n").filter(e=>""!==e.trim());await apiCall("?collection=settings&action=update",{method:"POST",body:JSON.stringify({incomePaymentMethods:e,expensePaymentMethods:t})}),await loadDashboardData(),showAlert("settingsAlert","Payment methods updated!","success")}function generateReport(){const e=document.getElementById("reportFromDate").value,t=document.getElementById("reportToDate").value;if(!e||!t)return void showAlert("reportsAlert","Please select both dates!","error");const s=expenses.filter(s=>s.date>=e&&s.date<=t),a=s.filter(e=>"In"===e.inOut).reduce((e,t)=>e+parseFloat(t.amount),0),n=s.filter(e=>"Out"===e.inOut).reduce((e,t)=>e+parseFloat(t.amount),0);document.getElementById("reportContent").innerHTML=`<div style="background:#f8f9fa;padding:20px;border-radius:10px;margin-top:20px"><h3>Financial Report (${e} to ${t})</h3><div style="display:grid;grid-template-columns:repeat(3,1fr);gap:20px;margin-top:20px"><div style="text-align:center"><h4 style="color:green">Total Income</h4><p style="font-size:24px;font-weight:bold">${systemSettings.currency}${a.toFixed(2)}</p></div><div style="text-align:center"><h4 style="color:red">Total Expenses</h4><p style="font-size:24px;font-weight:bold">${systemSettings.currency}${n.toFixed(2)}</p></div><div style="text-align:center"><h4 style="color:${a-n>=0?"green":"red"}">Net Profit</h4><p style="font-size:24px;font-weight:bold">${systemSettings.currency}${(a-n).toFixed(2)}</p></div></div></div><table class="table" style="margin-top:20px"><thead><tr><th>Reference</th><th>Date</th><th>Type</th><th>Amount</th><th>In/Out</th><th>Description</th></tr></thead><tbody>${s.map(e=>`<tr><td>${e.reference}</td><td>${e.date}</td><td>${e.type}</td><td>${systemSettings.currency}${parseFloat(e.amount).toFixed(2)}</td><td style="color:${e.inOut==="In"?"green":"red"}">${e.inOut==="In"?"Income":"Expense"}</td><td>${e.description||"-"}</td></tr>`).join("")}</tbody></table>`}function exportToExcel(){const e=document.getElementById("reportFromDate").value,t=document.getElementById("reportToDate").value;if(!e||!t)return void showAlert("reportsAlert","Please generate a report first!","error");const s=expenses.filter(s=>s.date>=e&&s.date<=t),a=s.map(e=>({Reference:e.reference,Date:e.date,Type:e.type,Amount:parseFloat(e.amount).toFixed(2),"In/Out":"In"===e.inOut?"Income":"Expense","Payment Method":e.paymentMethod,"Income Source":e.incomeSource||"-",Description:e.description||"-"})),n=XLSX.utils.json_to_sheet(a);n["!cols"]=[{wch:15},{wch:12},{wch:20},{wch:12},{wch:10},{wch:15},{wch:15},{wch:40}];const d=XLSX.utils.book_new();XLSX.utils.book_append_sheet(d,n,"Transactions");const o=s.filter(e=>"In"===e.inOut).reduce((e,t)=>e+parseFloat(t.amount),0),i=s.filter(e=>"Out"===e.inOut).reduce((e,t)=>e+parseFloat(t.amount),0),l=[["Financial Summary",""],["Period",`${e} to ${t}`],["Total Income",o.toFixed(2)],["Total Expenses",i.toFixed(2)],["Net Profit",(o-i).toFixed(2)]],r=XLSX.utils.aoa_to_sheet(l);XLSX.utils.book_append_sheet(d,r,"Summary"),XLSX.writeFile(d,`Nursery_Report_${e}_to_${t}.xlsx`,{bookType:"xlsx",type:"binary",codepage:65001}),showAlert("reportsAlert","Report exported!","success")}
    </script>
</body>
</html>
